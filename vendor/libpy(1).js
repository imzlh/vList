!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jspython={})}(this,(function(e){"use strict";var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},t(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)};function o(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}function s(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function a(e){return e.startsWith("/")||e.startsWith("./")?e.endsWith(".json")?"json":"jspyModule":"jsPackage"}function l(e,t,n,r,o){return"".concat(e,": ").concat(t,"(").concat(n,",").concat(r,"): ").concat(o)}"function"==typeof SuppressedError&&SuppressedError,function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=l("JspyTokenizerError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}n(t,e)}(Error);var c,u=function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=l("JspyParserError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}return n(t,e),t}(Error),h=function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=l("JspyEvalError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}return n(t,e),t}(Error),f=function(e){function t(n,r,o,i,s){var a=e.call(this)||this;return a.module=n,a.line=r,a.column=o,a.name=i,a.message=s,a.message=l("JspyError",n||"name.jspy",r,o,s),Object.setPrototypeOf(a,t.prototype),a}return n(t,e),t}(Error);!function(e){e[e.Arithmetic=0]="Arithmetic",e[e.Assignment=1]="Assignment",e[e.Comparison=2]="Comparison",e[e.Logical=3]="Logical",e[e.Membership=4]="Membership"}(c||(c={}));var p,d=new Map([["+",c.Arithmetic],["-",c.Arithmetic],["*",c.Arithmetic],["/",c.Arithmetic],["%",c.Arithmetic],["**",c.Arithmetic],["//",c.Arithmetic],[">",c.Comparison],[">=",c.Comparison],["==",c.Comparison],["!=",c.Comparison],["<>",c.Comparison],["<",c.Comparison],["<=",c.Comparison],["and",c.Logical],["or",c.Logical],["in",c.Membership],["=",c.Assignment],["+=",c.Assignment],["-=",c.Assignment],["*=",c.Assignment],["/=",c.Assignment],["++",c.Assignment],["--",c.Assignment]]),y=new Map([["+",function(e,t){return g(e,t,"+")}],["-",function(e,t){return g(e,t,"-")}],["/",function(e,t){return g(e,t,"/")}],["*",function(e,t){return g(e,t,"*")}],["%",function(e,t){return g(e,t,"%")}],["**",function(e,t){return g(e,t,"**")}],["//",function(e,t){return g(e,t,"//")}],[">",function(e,t){return m(e,t,">")}],[">=",function(e,t){return m(e,t,">=")}],["<",function(e,t){return m(e,t,"<")}],["<=",function(e,t){return m(e,t,"<=")}],["==",function(e,t){return m(e,t,"==")}],["!=",function(e,t){return m(e,t,"!=")}],["<>",function(e,t){return m(e,t,"<>")}],["and",function(e,t){return v(e,t,"and")}],["or",function(e,t){return v(e,t,"or")}],["in",function(e,t){return function(e,t,n){if("string"==typeof e)return e.includes(String(t));if(Array.isArray(e))return e.includes(t);throw new Error("Unknown operation '".concat(n,"'"))}(e,t,"in")}]]);function v(e,t,n){switch(n){case"and":return e&&t;case"or":return e||t}throw new Error("Unknown operation '".concat(n,"'"))}function m(e,t,n){switch(n){case"==":return e===t;case"!=":case"<>":return e!==t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}throw new Error("Unknown operation '".concat(n,"'"))}function g(e,t,n){switch(n){case"+":return e+t;case"-":return e-t;case"*":return e*t;case"/":return e/t;case"%":return e%t;case"**":return Math.pow(e,t)}throw new Error("Unknown operation '".concat(n,"'"))}function k(e){return e[1][0]}function b(e){return e?e[0]:null}function N(e){return e[1].subarray(1)}function w(e){return e[1][1]}function C(e){return e[1][2]}function x(e,t){var n=[];if(!e.length)return[];for(var r=0,o=0;o<t.length;o++){var i=t[o];"["===b(e[r-1])&&(r-=1),n.push(e.slice(r,i)),r=i+1}return"["===b(e[r-1])&&(r-=1),n.push(e.slice(r,e.length)),n}function A(e,t){return e.length?x(e,S(e,(function(e){return e===t}))):[]}function E(e,t,n){void 0===n&&(n=0);for(var r=n;r<e.length;r++)if(k(e[r])!==p.LiteralString)if("("===b(e[r]))r=L(e,r,"(",")");else if("["===b(e[r]))r=L(e,r,"[","]");else if("{"===b(e[r]))r=L(e,r,"{","}");else if(t(b(e[r])))return r;return-1}function S(e,t){for(var n=[],r=0;r<e.length;r++){var o=b(e[r]);k(e[r])!==p.LiteralString&&("("===o?r=L(e,r,"(",")"):"["===o?r=L(e,r,"[","]"):"{"===o?r=L(e,r,"{","}"):t(o)&&n.push(r))}return n}function _(e,t){return void 0===t&&(t=null),S(e,t?function(e){return d.get(e)===t}:function(e){return d.has(e)})}function L(e,t,n,r){for(var o=0;b(e[++t])!==r||0!==o;){if(t+1>=e.length)throw new Error("Closing '".concat(r,"' is missing"));var i=b(e[t]);i===n&&o++,i===r&&o--}return t}!function(e){e[e.Identifier=0]="Identifier",e[e.Keyword=1]="Keyword",e[e.Separator=2]="Separator",e[e.Operator=3]="Operator",e[e.LiteralNumber=4]="LiteralNumber",e[e.LiteralBool=5]="LiteralBool",e[e.LiteralString=6]="LiteralString",e[e.LiteralNull=7]="LiteralNull",e[e.Comment=8]="Comment"}(p||(p={}));var O=function(e){this.type=e,this.loc=void 0},T=function(e){function t(t,n,r){var o=e.call(this,"assign")||this;return o.target=t,o.source=n,o.loc=r,o.loc=r,o}return n(t,e),t}(O),j=function(e){function t(t){var n=e.call(this,"const")||this;return n.value=b(t),n.loc=N(t),n}return n(t,e),t}(O),B=function(e){function t(t,n){var r=e.call(this,"comment")||this;return r.comment=t,r.loc=n,r.loc=n,r}return n(t,e),t}(O),F=function(e){function t(t,n){void 0===t&&(t=void 0);var r=e.call(this,"return")||this;return r.returnValue=t,r.loc=n,r.loc=n,r}return n(t,e),t}(O),P=function(e){function t(t,n,r){var o=e.call(this,"raise")||this;return o.errorName=t,o.errorMessageAst=n,o.loc=r,o.loc=r,o}return n(t,e),t}(O),I=function(e){function t(){return e.call(this,"continue")||this}return n(t,e),t}(O),W=function(e){function t(){return e.call(this,"break")||this}return n(t,e),t}(O);!function(e){function t(t){var n=e.call(this,"setSingleVar")||this;return n.name=t[0],n.loc=N(t),n}n(t,e)}(O);var M=function(e){function t(t,n,r){var o=e.call(this,"funcCall")||this;return o.name=t,o.paramNodes=n,o.loc=r,o.nullCoelsing=void 0,o.loc=r,o}return n(t,e),t}(O),V=function(e){function t(t,n,r,o){var i=e.call(this,"funcDef")||this;return i.funcAst=t,i.params=n,i.isAsync=r,i.loc=o,i.loc=o,i}return n(t,e),t}(O),U=function(e){function t(t,n,r){var o=e.call(this,"arrowFuncDef")||this;return o.funcAst=t,o.params=n,o.loc=r,o.loc=r,o}return n(t,e),t}(O),J=function(e){function t(t,n,r){var o=e.call(this,"elif")||this;return o.conditionNode=t,o.elifBody=n,o.loc=r,o.loc=r,o}return n(t,e),t}(O),D=function(e){function t(t,n,r,o,i){void 0===r&&(r=void 0),void 0===o&&(o=void 0);var s=e.call(this,"if")||this;return s.conditionNode=t,s.ifBody=n,s.elifs=r,s.elseBody=o,s.loc=i,s.loc=i,s}return n(t,e),t}(O),z=function(e){function t(t,n,r,o,i){var s=e.call(this,"tryExcept")||this;return s.tryBody=t,s.exepts=n,s.elseBody=r,s.finallyBody=o,s.loc=i,s.loc=i,s}return n(t,e),t}(O),K=function(e){function t(t,n,r,o){var i=e.call(this,"for")||this;return i.sourceArray=t,i.itemVarName=n,i.body=r,i.loc=o,i.loc=o,i}return n(t,e),t}(O),R=function(e){function t(t,n,r){var o=e.call(this,"while")||this;return o.condition=t,o.body=n,o.loc=r,o.loc=r,o}return n(t,e),t}(O),G=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"import")||this;return i.module=t,i.body=n,i.parts=r,i.loc=o,i.loc=o,i}return n(t,e),t}(O),q=function(e){function t(t,n){void 0===n&&(n=void 0);var r=e.call(this,"getSingleVar")||this;return r.nullCoelsing=void 0,r.name=t[0],r.nullCoelsing=n,r.loc=N(t),r}return n(t,e),t}(O),H=function(e){function t(t,n){var r=e.call(this,"chainingCalls")||this;return r.innerNodes=t,r.loc=n,r.loc=n,r}return n(t,e),t}(O),Q=function(e){function t(t,n){var r=e.call(this,"createObject")||this;return r.props=t,r.loc=n,r.loc=n,r}return n(t,e),t}(O),X=function(e){function t(t,n){var r=e.call(this,"createArray")||this;return r.items=t,r.loc=n,r.loc=n,r}return n(t,e),t}(O),Y=function(e){function t(t,n,r){void 0===n&&(n=void 0);var o=e.call(this,"chainingObjectAccess")||this;return o.indexerBody=t,o.nullCoelsing=n,o.loc=r,o.loc=r,o}return n(t,e),t}(O),Z=function(e){function t(t,n){var r=e.call(this,"logicalOp")||this;return r.items=t,r.loc=n,r.loc=n,r}return n(t,e),t}(O),$=function(e){function t(t,n,r,o){var i=e.call(this,"binOp")||this;return i.left=t,i.op=n,i.right=r,i.loc=o,i.loc=o,i}return n(t,e),t}(O);function ee(e){return{moduleName:e.moduleName,blockScope:e.blockScope.clone(),cancellationToken:e.cancellationToken}}var te=function(){function e(e){this.scope={},this.scope=r({},e)}return e.prototype.getScope=function(){return this.scope},e.prototype.clone=function(){return new e(this.scope)},e.prototype.set=function(e,t){this.scope[e]=t},e.prototype.get=function(e){return this.scope[e]},e}(),ne=function(){function e(){}return e.prototype.evalBlock=function(e,t){for(var n=this,r=null,o=function(e){var r=e;t.blockScope.set(r.funcAst.name,(function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];return n.jspyFuncInvoker.apply(n,s([r,t],e,!1))}))},i=0,a=(null==e?void 0:e.funcs)||[];i<a.length;i++){o(c=a[i])}for(var l=0;l<e.body.length;l++){var c=e.body[l];if(t.cancellationToken.cancel){var u=c.loc||[];return t.cancellationToken.message||(t.cancellationToken.message="Cancelled. ".concat(t.moduleName,": ").concat(u[0],", ").concat(u[1])),t.cancellationToken.message}if("comment"!==c.type){if("import"===c.type)throw new Error("Import is not support with 'eval'. Use method 'evalAsync' instead");try{if(r=this.evalNode(c,t),t.returnCalled){var p=t.returnObject;return"func"!=e.type&&"module"!=e.type||(t.returnCalled=!1,t.returnObject=null),p}if(t.continueCalled)break;if(t.breakCalled)break}catch(e){u=c.loc?c.loc:[0,0];throw e instanceof f||e instanceof h?e:new h(t.moduleName,u[0],u[1],e.message||e)}}}return r},e.prototype.jspyFuncInvoker=function(e,t){for(var n,r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var i=Object.assign({},e.funcAst);i.type="func";for(var s=ee(t),a=0;a<(null===(n=e.params)||void 0===n?void 0:n.length);a++){var l=(null==r?void 0:r.length)>a?r[a]:null;s.blockScope.set(e.params[a],l)}return this.evalBlock(i,s)},e.prototype.invokeFunction=function(e,t,n){return e.apply(void 0,t)},e.prototype.evalNode=function(e,t){var n,r,o,i,a,l,c,u=this;if("import"===e.type)return null;if("comment"===e.type)return null;if("if"!==e.type){if("raise"===e.type){var h,p=e,d=this.evalNode(p.errorMessageAst,t);throw new f(t.moduleName,p.loc[0],p.loc[1],p.errorName,d)}if("tryExcept"!==e.type){if("return"===e.type){var v=e;return t.returnCalled=!0,t.returnObject=v.returnValue?this.evalNode(v.returnValue,t):null,t.returnObject}if("continue"!==e.type)if("break"!==e.type)if("for"!==e.type)if("while"!==e.type){if("const"===e.type)return e.value;if("getSingleVar"===e.type){var m=e.name,g=t.blockScope.get(e.name);if(void 0===g)throw";"===m.charAt(m.length-1)?new Error("Unexpected ';' in the end."):new Error("Variable '".concat(m,"' is not defined."));return g}if("binOp"===e.type){var k=e,b=this.evalNode(k.left,t),N=this.evalNode(k.right,t);if("function"==typeof(S=y.get(k.op)))return S(b,N);throw new Error("Unknown binary oprastion")}if("logicalOp"===e.type){for(var w=e,C=0,x=!0;C<w.items.length;){var A=w.items[C++];if(x=this.evalNode(A.node,t),"and"===A.op&&!x)return!1;if("or"===A.op&&x)return x}return x}if("arrowFuncDef"===e.type){var E=e;return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return u.jspyFuncInvoker.apply(u,s([E,t],e,!1))}}if("funcCall"===e.type){var S,_=e;if("function"!=typeof(S=t.blockScope.get(_.name)))throw Error("'".concat(_.name,"' is not a function or not defined."));var L=(null===(c=_.paramNodes)||void 0===c?void 0:c.map((function(e){return u.evalNode(e,t)})))||[];return this.invokeFunction(S,L,{moduleName:t.moduleName,line:_.loc[0],column:_.loc[1]})}if("assign"===e.type){var O=e;if("getSingleVar"===O.target.type){var T=O.target;t.blockScope.set(T.name,this.evalNode(O.source,t))}else if("chainingCalls"===O.target.type){var j=O.target,B=new H(j.innerNodes.slice(0,j.innerNodes.length-1),j.loc),F=this.evalNode(B,t),P=j.innerNodes[j.innerNodes.length-1],I="";if("getSingleVar"===P.type)I=P.name;else{if("chainingObjectAccess"!==P.type)throw Error("Not implemented Assign operation with chaining calls");I=this.evalNode(P.indexerBody,t)}F[I]=this.evalNode(O.source,t)}return null}if("chainingCalls"===e.type)return this.resolveChainingCallsNode(e,t);if("createObject"===e.type){for(var W={},M=0,V=e.props;M<V.length;M++){var U=V[M];W[this.evalNode(U.name,t)]=this.evalNode(U.value,t)}return W}if("createArray"===e.type){for(var J=[],D=0,z=e.items;D<z.length;D++){q=z[D];J.push(this.evalNode(q,t))}return J}}else{for(var K=e;this.evalNode(K.condition,t)&&(this.evalBlock({name:t.moduleName,type:"while",body:K.body},t),t.continueCalled&&(t.continueCalled=!1),!t.breakCalled););t.breakCalled&&(t.breakCalled=!1)}else{var R=e,G=this.evalNode(R.sourceArray,t);for(se=0;se<G.length;se++){var q=G[se];if(t.blockScope.set(R.itemVarName,q),this.evalBlock({name:t.moduleName,type:"for",body:R.body},t),t.continueCalled&&(t.continueCalled=!1),t.breakCalled)break}t.breakCalled&&(t.breakCalled=!1)}else t.breakCalled=!0;else t.continueCalled=!0}else{var Q=e;try{this.evalBlock({name:t.moduleName,type:"trycatch",body:Q.tryBody},t),(null===(r=Q.elseBody)||void 0===r?void 0:r.length)&&this.evalBlock({name:t.moduleName,type:"trycatch",body:Q.elseBody},t)}catch(h){var X=h instanceof f?h.name:typeof h,Y=h instanceof f?h.message:null!==(o=null==h?void 0:h.message)&&void 0!==o?o:String(h),Z=h instanceof f?h.module:0,$=h instanceof f?h.line:0,ee=h instanceof f?h.column:0,te=Q.exepts[0],ne=te.body,re=t;re.blockScope.set((null===(i=te.error)||void 0===i?void 0:i.alias)||"error",{name:X,message:Y,line:$,column:ee,moduleName:Z}),this.evalBlock({name:t.moduleName,type:"trycatch",body:ne},re),re.blockScope.set((null===(a=te.error)||void 0===a?void 0:a.alias)||"error",null)}finally{(null===(l=Q.finallyBody)||void 0===l?void 0:l.length)&&this.evalBlock({name:t.moduleName,type:"trycatch",body:Q.finallyBody},t)}}}else{var oe=e,ie=!0;if(this.evalNode(oe.conditionNode,t))this.evalBlock({name:t.moduleName,type:"if",body:oe.ifBody},t),ie=!1;else if(null===(n=oe.elifs)||void 0===n?void 0:n.length)for(var se=0;se<oe.elifs.length;se++){var ae=oe.elifs[se];if(this.evalNode(ae.conditionNode,t)){this.evalBlock({name:t.moduleName,type:"if",body:ae.elifBody},t),ie=!1;break}}ie&&oe.elseBody&&this.evalBlock({name:t.moduleName,type:"if",body:oe.elseBody},t)}},e.prototype.resolveChainingCallsNode=function(e,t){for(var n=this.evalNode(e.innerNodes[0],t),r=1;r<e.innerNodes.length;r++){var o=e.innerNodes[r];if(e.innerNodes[r-1].nullCoelsing&&!n&&(n={}),"getSingleVar"===o.type)n=n[o.name];else if("chainingObjectAccess"===o.type){var i=o;n=n[this.evalNode(i.indexerBody,t)]}else{if("funcCall"!==o.type)throw Error("Can't resolve chainingCalls node");var s=o,a=n[s.name];if(null==a&&e.innerNodes[r-1].nullCoelsing){n=null;continue}if("function"!=typeof a)throw Error("'".concat(s.name,"' is not a function or not defined."));for(var l=[],c=0,u=s.paramNodes||[];c<u.length;c++){var h=u[c];l.push(this.evalNode(h,t))}n=this.invokeFunction(a.bind(n),l,{moduleName:t.moduleName,line:s.loc[0],column:s.loc[0]})}}return void 0===n?null:n},e}(),re=function(){function e(){this.moduleParser=function(){return Promise.reject("Module parser is not registered!")},this.jsonFileLoader=function(){return Promise.reject("{}")}}return e.prototype.registerModuleParser=function(e){return this.moduleParser=e,this},e.prototype.registerJsonFileLoader=function(e){return this.jsonFileLoader=e,this},e.prototype.registerBlockContextFactory=function(e){return this.blockContextFactory=e,this},e.prototype.evalBlockAsync=function(e,t){var n,r;return o(this,void 0,void 0,(function(){var l,c,u,p,d,y,v,m,g,k,b,N,w,C,x,A,E,S=this;return i(this,(function(_){switch(_.label){case 0:for(l=null,c=function(e){var n=e,r=t.blockScope,a=n.isAsync?function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return o(S,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,this.jspyFuncInvokerAsync.apply(this,s([n,t],e,!1))];case 1:return[2,r.sent()]}}))}))}:function(){for(var e,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return(e=new ne).jspyFuncInvoker.apply(e,s([n,t],r,!1))};r.set(n.funcAst.name,a)},u=0,p=(null==e?void 0:e.funcs)||[];u<p.length;u++)y=p[u],c(y);d=0,_.label=1;case 1:return d<e.body.length?(y=e.body[d],t.cancellationToken.cancel?(E=y.loc||[],t.cancellationToken.message||(t.cancellationToken.message="Cancelled. ".concat(t.moduleName,": ").concat(E[0],", ").concat(E[1])),[2,t.cancellationToken.message]):"comment"===y.type?[3,10]:"import"!==y.type?[3,7]:"json"!==(m=a((v=y).module.name))?[3,3]:(b=(k=JSON).parse,[4,this.jsonFileLoader(v.module.name)])):[3,11];case 2:return g=b.apply(k,[_.sent()]),t.blockScope.set(v.module.alias||this.defaultModuleName(v.module.name),g),[3,10];case 3:if("jspyModule"!==m)return[3,10];_.label=4;case 4:if("function"!=typeof this.blockContextFactory)throw new Error("blockContextFactory is not initialized");return[4,this.moduleParser(v.module.name)];case 5:return N=_.sent(),w=this.blockContextFactory(v.module.name,N),[4,this.evalBlockAsync(N,w)];case 6:return _.sent(),C=t.blockScope.getScope(),(null===(n=v.parts)||void 0===n?void 0:n.length)||(C={},t.blockScope.set(v.module.alias||this.defaultModuleName(v.module.name),C)),this.assignFunctionsToScope(C,w,N,null===(r=v.parts)||void 0===r?void 0:r.map((function(e){return e.name}))),[3,10];case 7:return _.trys.push([7,9,,10]),[4,this.evalNodeAsync(y,t)];case 8:return l=_.sent(),t.returnCalled?(x=t.returnObject,"func"!=e.type&&"module"!=e.type||(t.returnCalled=!1,t.returnObject=null),[2,x]):t.continueCalled||t.breakCalled?[3,11]:[3,10];case 9:throw A=_.sent(),E=y.loc?y.loc:[0,0],A instanceof f||A instanceof h?A:new h(t.moduleName,E[0],E[1],A.message||A);case 10:return d++,[3,1];case 11:return[2,l]}}))}))},e.prototype.assignFunctionsToScope=function(e,t,n,r){for(var a=this,l=n.funcs.filter((function(e){var t;return!r||r.indexOf(null===(t=e.funcAst)||void 0===t?void 0:t.name)>=0})),c=function(n){var r=l[n],c=r.isAsync?function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return o(a,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,this.jspyFuncInvokerAsync.apply(this,s([r,t],e,!1))];case 1:return[2,n.sent()]}}))}))}:function(){for(var e,n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];return(e=new ne).jspyFuncInvoker.apply(e,s([r,t],n,!1))};e[r.funcAst.name]=c},u=0;u<l.length;u++)c(u)},e.prototype.defaultModuleName=function(e){return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))},e.prototype.jspyFuncInvokerAsync=function(e,t){for(var n,r=[],s=2;s<arguments.length;s++)r[s-2]=arguments[s];return o(this,void 0,void 0,(function(){var o,s,a,l;return i(this,(function(i){switch(i.label){case 0:for((o=Object.assign({},e.funcAst)).type="func",s=ee(t),a=0;a<(null===(n=e.params)||void 0===n?void 0:n.length);a++)l=(null==r?void 0:r.length)>a?r[a]:null,s.blockScope.set(e.params[a],l);return[4,this.evalBlockAsync(o,s)];case 1:return[2,i.sent()]}}))}))},e.prototype.invokeFunctionAsync=function(e,t,n){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,e.apply(void 0,t)];case 1:return[2,n.sent()]}}))}))},e.prototype.evalNodeAsync=function(e,t){var n,r,a,l,c,u;return o(this,void 0,void 0,(function(){var o,h,p,d,v,m,g,k,b,N,w,C,x,A,E,S,_,L,O,T,j,B,F,P,I,W,M,V,U,J,D,z,K,R,G,q,Q,X,Y,Z,$,ee,te,re,oe,ie,se,ae,le,ce,ue,he,fe,pe,de,ye,ve,me,ge,ke,be,Ne,we;return i(this,(function(i){switch(i.label){case 0:if("import"===e.type)throw new Error("Import should be defined at the start");return"comment"===e.type?[2,null]:"if"!==e.type?[3,11]:(o=e,h=!0,[4,this.evalNodeAsync(o.conditionNode,t)]);case 1:return i.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:o.ifBody},t)]:[3,3];case 2:return i.sent(),h=!1,[3,8];case 3:if(!(null===(n=o.elifs)||void 0===n?void 0:n.length))return[3,8];j=0,i.label=4;case 4:return j<o.elifs.length?(p=o.elifs[j],[4,this.evalNodeAsync(p.conditionNode,t)]):[3,8];case 5:return i.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:p.elifBody},t)]:[3,7];case 6:return i.sent(),h=!1,[3,8];case 7:return j++,[3,4];case 8:return h&&o.elseBody?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:o.elseBody},t)]:[3,10];case 9:i.sent(),i.label=10;case 10:return[2];case 11:return"raise"!==e.type?[3,13]:(d=e,[4,this.evalNodeAsync(d.errorMessageAst,t)]);case 12:throw v=i.sent(),new f(t.moduleName,d.loc[0],d.loc[1],d.errorName,v);case 13:if("tryExcept"!==e.type)return[3,24];m=e,i.label=14;case 14:return i.trys.push([14,18,20,23]),[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:m.tryBody},t)];case 15:return i.sent(),(null===(r=m.elseBody)||void 0===r?void 0:r.length)?[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:m.elseBody},t)]:[3,17];case 16:i.sent(),i.label=17;case 17:return[3,23];case 18:return g=i.sent(),k=g instanceof f?g.name:typeof g,b=g instanceof f?g.message:null!==(a=null==g?void 0:g.message)&&void 0!==a?a:String(g),N=g instanceof f?g.module:0,w=g instanceof f?g.line:0,C=g instanceof f?g.column:0,x=m.exepts[0],A=x.body,(E=t).blockScope.set((null===(l=x.error)||void 0===l?void 0:l.alias)||"error",{name:k,message:b,line:w,column:C,moduleName:N}),[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:A},E)];case 19:return i.sent(),E.blockScope.set((null===(c=x.error)||void 0===c?void 0:c.alias)||"error",null),[3,23];case 20:return(null===(u=m.finallyBody)||void 0===u?void 0:u.length)?[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:m.finallyBody},t)]:[3,22];case 21:i.sent(),i.label=22;case 22:return[7];case 23:return[2];case 24:return"return"!==e.type?[3,28]:(S=e,t.returnCalled=!0,_=t,S.returnValue?[4,this.evalNodeAsync(S.returnValue,t)]:[3,26]);case 25:return L=i.sent(),[3,27];case 26:L=null,i.label=27;case 27:return _.returnObject=L,[2,t.returnObject];case 28:return"continue"===e.type?(t.continueCalled=!0,[2]):"break"===e.type?(t.breakCalled=!0,[2]):"for"!==e.type?[3,34]:(O=e,[4,this.evalNodeAsync(O.sourceArray,t)]);case 29:T=i.sent(),j=0,i.label=30;case 30:return j<T.length?(be=T[j],t.blockScope.set(O.itemVarName,be),[4,this.evalBlockAsync({name:t.moduleName,type:"for",body:O.body},t)]):[3,33];case 31:if(i.sent(),t.continueCalled&&(t.continueCalled=!1),t.breakCalled)return[3,33];i.label=32;case 32:return j++,[3,30];case 33:return t.breakCalled&&(t.breakCalled=!1),[2];case 34:if("while"!==e.type)return[3,39];B=e,i.label=35;case 35:return[4,this.evalNodeAsync(B.condition,t)];case 36:return i.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"while",body:B.body},t)]:[3,38];case 37:return i.sent(),t.continueCalled&&(t.continueCalled=!1),t.breakCalled?[3,38]:[3,35];case 38:return t.breakCalled&&(t.breakCalled=!1),[2];case 39:if("const"===e.type)return[2,e.value];if("getSingleVar"===e.type){if(F=e.name,void 0===(P=t.blockScope.get(F)))throw";"===F.charAt(F.length-1)?new Error("Unexpected ';' in the end."):new Error("Variable '".concat(F,"' is not defined."));return[2,P]}return"binOp"!==e.type?[3,42]:(I=e,[4,this.evalNodeAsync(I.left,t)]);case 40:return W=i.sent(),[4,this.evalNodeAsync(I.right,t)];case 41:if(M=i.sent(),"function"==typeof(R=y.get(I.op)))return[2,R(W,M)];throw new Error("Unknown binary oprastion");case 42:if("logicalOp"!==e.type)return[3,46];V=e,U=0,J=!0,i.label=43;case 43:return U<V.items.length?(D=V.items[U++],[4,this.evalNodeAsync(D.node,t)]):[3,45];case 44:return J=i.sent(),"and"!==D.op||J?"or"===D.op&&J?[2,J]:[3,43]:[2,!1];case 45:return[2,J];case 46:if("arrowFuncDef"===e.type)return z=e,[2,function(){for(var e,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return(e=new ne).jspyFuncInvoker.apply(e,s([z,t],n,!1))}];if("funcCall"!==e.type)return[3,52];if(K=e,"function"!=typeof(R=t.blockScope.get(K.name)))throw Error("'".concat(K.name,"' is not a function or not defined."));G=[],q=0,Q=K.paramNodes||[],i.label=47;case 47:return q<Q.length?(de=Q[q],Y=(X=G).push,[4,this.evalNodeAsync(de,t)]):[3,50];case 48:Y.apply(X,[i.sent()]),i.label=49;case 49:return q++,[3,47];case 50:return[4,this.invokeFunctionAsync(R,G,{moduleName:t.moduleName,line:K.loc[0],column:K.loc[0]})];case 51:return[2,i.sent()];case 52:return"assign"!==e.type?[3,62]:"getSingleVar"!==(Z=e).target.type?[3,54]:($=Z.target,te=(ee=t.blockScope).set,re=[$.name],[4,this.evalNodeAsync(Z.source,t)]);case 53:return te.apply(ee,re.concat([i.sent()])),[3,61];case 54:return"chainingCalls"!==Z.target.type?[3,61]:(oe=Z.target,ie=new H(oe.innerNodes.slice(0,oe.innerNodes.length-1),oe.loc),[4,this.evalNodeAsync(ie,t)]);case 55:return se=i.sent(),ae=oe.innerNodes[oe.innerNodes.length-1],le="","getSingleVar"!==ae.type?[3,56]:(le=ae.name,[3,59]);case 56:return"chainingObjectAccess"!==ae.type?[3,58]:[4,this.evalNodeAsync(ae.indexerBody,t)];case 57:return le=i.sent(),[3,59];case 58:throw Error("Not implemented Assign operation with chaining calls");case 59:return ce=se,ue=le,[4,this.evalNodeAsync(Z.source,t)];case 60:ce[ue]=i.sent(),i.label=61;case 61:return[2,null];case 62:return"chainingCalls"!==e.type?[3,64]:[4,this.resolveChainingCallsNode(e,t)];case 63:return[2,i.sent()];case 64:if("createObject"!==e.type)return[3,70];he={},fe=0,pe=e.props,i.label=65;case 65:return fe<pe.length?(de=pe[fe],ye=he,[4,this.evalNodeAsync(de.name,t)]):[3,69];case 66:return ve=i.sent(),[4,this.evalNodeAsync(de.value,t)];case 67:ye[ve]=i.sent(),i.label=68;case 68:return fe++,[3,65];case 69:return[2,he];case 70:if("createArray"!==e.type)return[3,75];me=[],ge=0,ke=e.items,i.label=71;case 71:return ge<ke.length?(be=ke[ge],we=(Ne=me).push,[4,this.evalNodeAsync(be,t)]):[3,74];case 72:we.apply(Ne,[i.sent()]),i.label=73;case 73:return ge++,[3,71];case 74:return[2,me];case 75:return[2]}}))}))},e.prototype.resolveChainingCallsNode=function(e,t){return o(this,void 0,void 0,(function(){var n,r,o,s,a,l,c,u,h,f,p,d,y;return i(this,(function(i){switch(i.label){case 0:return[4,this.evalNodeAsync(e.innerNodes[0],t)];case 1:n=i.sent(),r=1,i.label=2;case 2:return r<e.innerNodes.length?(o=e.innerNodes[r],e.innerNodes[r-1].nullCoelsing&&!n&&(n={}),"getSingleVar"!==o.type?[3,3]:(n=n[o.name],[3,12])):[3,13];case 3:return"chainingObjectAccess"!==o.type?[3,5]:(s=o,a=n,[4,this.evalNodeAsync(s.indexerBody,t)]);case 4:return n=a[i.sent()],[3,12];case 5:if("funcCall"!==o.type)return[3,11];if(null==(c=n[(l=o).name])&&e.innerNodes[r-1].nullCoelsing)return n=null,[3,12];if("function"!=typeof c)throw Error("'".concat(l.name,"' is not a function or not defined."));u=[],h=0,f=l.paramNodes||[],i.label=6;case 6:return h<f.length?(p=f[h],y=(d=u).push,[4,this.evalNodeAsync(p,t)]):[3,9];case 7:y.apply(d,[i.sent()]),i.label=8;case 8:return h++,[3,6];case 9:return[4,this.invokeFunctionAsync(c.bind(n),u,{moduleName:t.moduleName,line:l.loc[0],column:l.loc[0]})];case 10:return n=i.sent(),[3,12];case 11:throw Error("Can't resolve chainingCalls node");case 12:return r++,[3,2];case 13:return[2,void 0===n?null:n]}}))}))},e}(),oe={jsPython:function(){return"JSPython v2.1.10 (c) 2022 FalconSoft Ltd. All rights reserved."},dateTime:function(e){return void 0===e&&(e=null),function(e){if(!e)return null;if("number"==typeof e)return new Date(e);if(e instanceof Date&&!isNaN(e.valueOf()))return e;if("string"!=typeof e)return null;var t=String(e);if(!t.length)return null;var n=function(e){if(!e||!e.length)return NaN;var t=parseInt(e,10);return isNaN(t)?e.startsWith("jan")?0:e.startsWith("feb")?1:e.startsWith("mar")?2:e.startsWith("apr")?3:e.startsWith("may")?4:e.startsWith("jun")?5:e.startsWith("jul")?6:e.startsWith("aug")?7:e.startsWith("sep")?8:e.startsWith("oct")?9:e.startsWith("nov")?10:e.startsWith("dec")?11:NaN:t-1},r=function(e){return e<100?e<68?e+2e3:e+1900:e},o=function(e,t,n,r,o,i){if(t>11||n>31||r>=60||o>=60||i>=60)return null;var s=new Date(e,t,n,r,o,i,0);return isNaN(s.valueOf())?null:s},i=t.replace("T"," ").toLowerCase().split(/[: /-]/),s=i.map(parseFloat),a=o(s[0],s[1]-1,s[2],s[3]||0,s[4]||0,s[5]||0);return a||((a=o(r(s[2]),n(i[1]),s[0],s[3]||0,s[4]||0,s[5]||0))?a:(a=o(r(s[2]),n(i[0]),r(s[1]),s[3]||0,s[4]||0,s[5]||0))||null)}(e)||new Date},range:function(e,t,n){void 0===t&&(t=NaN);void 0===n&&(n=1);var r=[],o=isNaN(t);t=o?e:t;var i=e=o?0:e;for(;i<t;)r.push(i),i+=n;return r},print:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return console.log.apply(console,e),e.length>0?e[0]:null},isNull:function(e,t){return void 0===t&&(t=null),null===t?null===e:e||t},isDate:function(e){return e instanceof Date},isFunction:function(e){return"function"==typeof e},isString:function(e){return"string"==typeof e},deleteProperty:function(e,t){return delete e[t]},Math:Math,Object:Object,Array:Array,JSON:JSON,printExecutionContext:function(){},getExecutionContext:function(){return{}}};var ie=function(){function e(){this.tokens=[]}return e.prototype.startLine=function(){return w(this.tokens[0])},e.prototype.startColumn=function(){return C(this.tokens[0])},e.prototype.endLine=function(){return this.tokens[this.tokens.length-1][1][3]},e.prototype.endColumn=function(){return this.tokens[this.tokens.length-1][1][4]},e}(),se=function(){function e(){this._currentToken=null,this._moduleName=""}return e.prototype.parse=function(e,t,n){var r;void 0===t&&(t="main.jspy"),void 0===n&&(n="module"),this._moduleName=t;var o={name:t,type:n,funcs:[],body:[]};if(!e||!e.length)return o;try{var i=this.tokensToInstructionLines(e,1);this.instructionsToNodes(i,o)}catch(e){var s=e,a=null!==(r=this._currentToken)&&void 0!==r?r:{};throw new u(o.name,w(a),C(a),s.message||String(s))}return o},e.prototype.instructionsToNodes=function(e,t){for(var n=this,r=function(e,r){var o=n.tokensToInstructionLines(e,w(e[r])),i={name:t.name,body:[],funcs:[]};return n.instructionsToNodes(o,i),i.body},o=function(e,t,n){return n.splice(0,n.length),_(e,t).forEach((function(e){return n.push(e)})),!!n.length},i=0;i<e.length;i++){for(var s=e[i],a=0;a<s.tokens.length;)k(s.tokens[a])===p.Comment?s.tokens.splice(a,1):a++;if(s.tokens.length){var l=s.tokens[0],u=s.tokens.length>1?s.tokens[1]:null;this._currentToken=l;var h=[];if(k(l)===p.Comment)t.body.push(new B(b(l),N(l)));else if("def"===b(l)||"async"===b(l)&&"def"===b(u)){var f="async"===b(l),d=b(s.tokens[f?2:1]),y=A(s.tokens.slice(s.tokens.findIndex((function(e){return"("===b(e)}))+1,s.tokens.findIndex((function(e){return")"===b(e)}))),",").map((function(e){return b(e[0])}));if(-1===(re=E(s.tokens,(function(e){return":"===e}))))throw"Can't find : for def";var v=this.tokensToInstructionLines(s.tokens,w(s.tokens[re+1])),m={name:d,body:[],funcs:[]};this.instructionsToNodes(v,m),t.funcs.push(new V(m,y,f,N(s.tokens[0])))}else if("if"===b(l)){if(-1===(re=E(s.tokens,(function(e){return":"===e}))))throw"Can't find : for if";for(var g=r(s.tokens,re+1),C=o(oe=s.tokens.slice(1,re),c.Logical,h)?this.groupLogicalOperations(h,oe):this.createExpressionNode(oe),x=[];e.length>i+1&&"elif"===b(e[i+1].tokens[0]);){var S=e[++i],L=E(S.tokens,(function(e){return":"===e})),O=S.tokens.slice(1,re),j=o(O,c.Logical,h)?this.groupLogicalOperations(h,O):this.createExpressionNode(O),M=r(S.tokens,L+1);x.push(new J(j,M,N(S.tokens[0])))}var U=void 0;e.length>i+1&&"else"===b(e[i+1].tokens[0])&&":"===b(e[i+1].tokens[1])&&(U=r(e[i+1].tokens,2),i++),t.body.push(new D(C,g,x,U,N(l)))}else if("try"===b(l)){if(":"!==b(s.tokens[1]))throw"'try' statement should be followed by ':'";for(var q=r(s.tokens,2),H=[],Q=(U=void 0,void 0);e.length>i+1&&("else"===b(e[i+1].tokens[0])||"except"===b(e[i+1].tokens[0])||"finally"===b(e[i+1].tokens[0]));){if("else"===b(e[i+1].tokens[0])){if(U)throw new Error("Only one 'else' is allowed in a 'try'");U=r(e[i+1].tokens,2)}if("finally"===b(e[i+1].tokens[0])){if(Q)throw new Error("Only one 'else' is allowed in a 'try'");Q=r(e[i+1].tokens,2)}if("except"===b(e[i+1].tokens[0])){var X=E(e[i+1].tokens,(function(e){return":"===e})),Y={};if(2===X)Y.error={name:b(e[i+1].tokens[1])};else if(3===X)Y.error={name:b(e[i+1].tokens[1]),alias:b(e[i+1].tokens[2])};else if(4===X)Y.error={name:b(e[i+1].tokens[1]),alias:b(e[i+1].tokens[3])};else if(1!==X)throw new Error("Incorrect 'except:' statement. Valid stats: (except: or except Error: or except Error as e:)");Y.body=r(e[i+1].tokens,X+1),H.push(Y)}i++}if(!H.length)throw new Error("Except: is missing");t.body.push(new z(q,H,U,Q,N(l)))}else if("continue"===b(l))t.body.push(new I);else if("break"===b(l))t.body.push(new W);else if("return"===b(l))t.body.push(new F(s.tokens.length>1?this.createExpressionNode(s.tokens.slice(1)):void 0,N(l)));else if("raise"===b(l)){if(1===s.tokens.length)throw new Error("Incorrect 'raise' usage. Please specify error name and message ");var Z=b(s.tokens[1]),$=this.createExpressionNode(s.tokens.slice(1));t.body.push(new P(Z,$,N(l)))}else if("for"===b(l)){if(-1===(re=E(s.tokens,(function(e){return":"===e}))))throw"Can't find : for if";var ee=b(s.tokens[1]),te=this.createExpressionNode(s.tokens.slice(3,re)),ne=r(s.tokens,re+1);t.body.push(new K(te,ee,ne,N(l)))}else if("while"===b(l)){var re;if(-1===(re=E(s.tokens,(function(e){return":"===e}))))throw"Can't find : for [while]";C=o(oe=s.tokens.slice(1,re),c.Logical,h)?this.groupLogicalOperations(h,oe):this.createExpressionNode(oe);var oe,ie=r(s.tokens,re+1);t.body.push(new R(C,ie,N(l)))}else if("import"===b(l)){var se=E(s.tokens,(function(e){return"as"===e}));se<0&&(se=s.tokens.length);var ae={name:s.tokens.slice(1,se).map((function(e){return b(e)})).join(""),alias:s.tokens.slice(se+1).map((function(e){return b(e)})).join("")||void 0};ie={};t.body.push(new G(ae,ie,void 0,N(l)))}else if("from"===b(l)){var le=E(s.tokens,(function(e){return"import"===e}));if(le<0)throw Error("'import' must follow 'from'");var ce={name:s.tokens.slice(1,le).map((function(e){return b(e)})).join("")},ue=A(s.tokens.slice(le+1),",").map((function(e){return{name:b(e[0]),alias:3===e.length?b(e[2]):void 0}}));ie={};t.body.push(new G(ce,ie,ue,N(l)))}else if(o(s.tokens,c.Assignment,[])){var he=A(s.tokens,"="),fe=this.createExpressionNode(he[0]),pe=this.createExpressionNode(he[1]);t.body.push(new T(fe,pe,N(he[0][0])))}else o(s.tokens,c.Logical,h)?t.body.push(this.groupLogicalOperations(h,s.tokens)):t.body.push(this.createExpressionNode(s.tokens))}}},e.prototype.sliceWithBrackets=function(e,t,n){return"("===b(e[t])&&k(e[t])!==p.LiteralString&&(t++,n--),e.slice(t,n)},e.prototype.groupComparisonOperations=function(e,t){for(var n=null,r=0;r<e.length;r++){var o=b(t[e[r]]);n=n||this.createExpressionNode(this.sliceWithBrackets(t,0,e[r]));var i=r+1<e.length?e[r+1]:t.length,s=this.createExpressionNode(this.sliceWithBrackets(t,e[r]+1,i));n=new $(n,o,s,N(t[0]))}return n},e.prototype.groupLogicalOperations=function(e,t){for(var n=0,r=[],o=0;o<e.length;o++){var i=t[e[o]],s=this.sliceWithBrackets(t,n,e[o]);r.push({node:this.createExpressionNode(s),op:b(i)}),n=e[o]+1}return r.push({node:this.createExpressionNode(this.sliceWithBrackets(t,n,t.length))}),new Z(r,N(t[0]))},e.prototype.tokensToInstructionLines=function(e,t){for(var n=[],r=0,o=new ie,i=0;i<e.length;i++){var s=e[i],a=w(s),l=C(s),c=b(s);if(this._currentToken=s,a>=t&&(r!==l||")}]".includes(c)||(n.push(o),o=new ie),o.tokens.push(s),0===r&&(r=l),l<r))break}return o.tokens.length&&n.push(o),n},e.prototype.createExpressionNode=function(e){var t=this;if(0===e.length)throw new Error("Tokens length can't empty.");var n=e[e.length-1];if(";"===b(n)&&k(n)!==p.LiteralString)throw new Error("Unexpected symbol ';' in the end");if(this._currentToken=e[0],1===e.length||2===e.length&&"?"===b(e[1])){var r=e[0],o=k(r);if(function(e){return e===p.LiteralString||e===p.LiteralNumber||e===p.LiteralBool||e===p.LiteralNull}(o))return new j(r);if(o===p.Identifier)return new q(r,2===e.length&&"?"===b(e[1])||void 0);throw Error("Unhandled single token: '".concat(JSON.stringify(r),"'"))}var i=A(e,"=>");if(i.length>1){var s=A("("===b(i[0][0])?i[0].splice(1,i[0].length-2):i[0],",").map((function(e){return b(e[0])})),a=this.tokensToInstructionLines(i[1],0),l={name:this._moduleName,body:[],funcs:[]};return this.instructionsToNodes(a,l),new U(l,s,N(e[0]))}var u=_(e,c.Comparison);if(u.length)return this.groupComparisonOperations(u,e);var h=_(e);if(h.length){for(var f=null,d=0;d<h.length;d++){var y=h[d],v=b(e[y]),m=d+1<h.length?h[d+1]:null,g=null!==m?b(e[m]):null;if(null===m||"*"!==g&&"/"!==g){I=f?[]:this.sliceWithBrackets(e,0,y);var w=this.sliceWithBrackets(e,y+1,m||e.length),C=f||this.createExpressionNode(I),E=this.createExpressionNode(w);f=new $(C,v,E,N(e[0]))}else{var S=null;do{var O=d+2<h.length?h[d+2]:null,T=this.sliceWithBrackets(e,y+1,m),B=this.sliceWithBrackets(e,m+1,O||e.length),F=this.createExpressionNode(T),P=this.createExpressionNode(B);S=new $(F,g,P,N(e[y+1])),g=null!==(m=++d+1<h.length?h[d+1]:null)?b(e[m]):null}while(null!==m&&("*"===g||"/"===g));if(null===f){var I=this.sliceWithBrackets(e,0,y);f=this.createExpressionNode(I)}f=new $(f,v,S,N(e[0]))}}if(null===f)throw Error("Can't create node ...");return f}var W=function(e){for(var t=[],n=0;n<e.length;n++){var r=b(e[n]);k(e[n])!==p.LiteralString&&("."===r?t.push(n):"("===r?n=L(e,n,"(",")"):"["===r&&0===n?n=L(e,n,"[","]"):"["===r&&0!==n?(t.push(n),n=L(e,n,"[","]")):"{"===r&&(n=L(e,n,"{","}")))}return t}(e);if(W.length>0){var V=x(e,W),J=[];for(d=0;d<V.length;d++){var D=V[d];if(0===d||"["!==b(D[0]))J.push(this.createExpressionNode(D));else{var z="?"===b(D[D.length-1]);z&&D.pop();var K=D.slice(1,D.length-1),R=this.createExpressionNode(K);J.push(new Y(R,z,N(D[0])))}}return new H(J,N(e[0]))}if(e.length>2&&"("===b(e[1])){var G="?"===b(e[e.length-1]);G&&e.pop();var Z=b(e[0]),ee=(R=A(K=e.slice(2,e.length-1),",").map((function(e){return t.createExpressionNode(e)})),new M(Z,R,N(e[0])));return ee.nullCoelsing=G||void 0,ee}if("{"===b(e[0])&&"}"===b(e[e.length-1])){var te=A(e.splice(1,e.length-2),","),ne=[];for(d=0;d<te.length;d++){var re=A(te[d],":");if(1===re.length){var oe={name:new j(re[0][0]),value:this.createExpressionNode(re[0])};ne.push(oe)}else{if(2!==re.length)throw Error("Incorrect JSON");var ie=null,se=re[0];if(1===se.length)ie=new j(se[0]);else{if("["!==b(se[0])||"]"!==b(se[se.length-1]))throw new Error("Incorrect JSON. Can't resolve Key field. That should either constant or expression in []");ie=this.createExpressionNode(se.slice(1,se.length-1))}oe={name:ie,value:this.createExpressionNode(re[1])};ne.push(oe)}}return new Q(ne,N(e[0]))}if("["===b(e[0])&&"]"===b(e[e.length-1])){var ae=A(e.splice(1,e.length-2),",").map((function(e){return t.createExpressionNode(e)}));return new X(ae,N(e[0]))}throw Error("Undefined node '".concat(b(e[0]),"'."))},e}(),ae={"\n":["\n"],"=":["=","==","=>"],"+":["+","++","+="],"-":["-","--","-="],"*":["*","**","*="],"/":["/","//","/="],".":["."],"?":["?"],"!":["!="],":":[":"],",":[","],">":[">",">="],"<":["<","<=","<>"],"(":["("],")":[")"],"{":["{"],"}":["}"],"[":["["],"]":["]"]},le=['"',"'","\\"],ce=["async","def","for","while","if","return","in"],ue=function(){function e(){this._startLine=1,this._startColumn=1,this._currentLine=1,this._currentColumn=1,this._tokenText="",this._cursor=0,this._script=""}return Object.defineProperty(e.prototype,"tokenText",{get:function(){return this._tokenText},set:function(e){!this._tokenText&&e&&(this._startLine=this._currentLine,this._startColumn=this._currentColumn),this._tokenText=e},enumerable:!1,configurable:!0}),e.prototype.tokenize=function(e){if(!e||!e.length)return[];e=e.replace(new RegExp("\t","g"),"  ").replace(new RegExp("\r","g"),""),this._script=e,this._cursor=0,this._startLine=1,this._startColumn=1,this._currentLine=1,this._currentColumn=1;for(var t=[],n=!0;"\n"===e[this._cursor];)this.incrementCursor(),n&&(this._currentLine++,n=!1),this._currentColumn=1;do{var r=e[this._cursor];if(" "!=r||0===this.tokenText.length)if(void 0===ae[r]||this.isPartOfNumber(r,t))if("#"===r){for(var o=!0;"\n"!==e[this.incrementCursor()]&&(this.tokenText+=e[this._cursor],o&&(o=!1,this._startColumn=this._startColumn-1),!(this._cursor+1>=e.length)););this.tokenText=this.processToken(this.tokenText,t,!0,p.Comment)}else if('"'===r||"'"===r){var i=r;if(this.tokenText=this.processToken(this.tokenText,t),e[this._cursor+1]===i&&e[this._cursor+2]===i){var s=this._currentLine,a=this._currentColumn;this.incrementCursor(2);for(;this.tokenText+=e[this.incrementCursor()],!(this._cursor+3>=e.length||e[this._cursor+1]===i&&e[this._cursor+2]===i&&e[this._cursor+3]===i););this._startLine=s,this._startColumn=a,this.incrementCursor(3)}else{for(;e[this.incrementCursor()]!==i;)if("\\"===e[this._cursor]&&le.indexOf(e[this._cursor+1])>=0&&this._cursor++,this.tokenText+=e[this._cursor],this._cursor+1>=e.length)throw new Error("Line ".concat(this._startLine,": End of string missing."));this._startColumn--}0===this.tokenText.length&&(this._startLine=this._currentLine,this._startColumn=this._currentColumn),this.tokenText=this.processToken(this.tokenText,t,!0,p.LiteralString)}else" "!=r&&(this.tokenText+=r);else{this.tokenText=this.processToken(this.tokenText,t),this.tokenText=r;var l=ae[r];if(l.length>=1)for(;l.includes(this.tokenText+e[this._cursor+1]);)this.tokenText+=e[this.incrementCursor()];this.tokenText=this.processToken(this.tokenText,t,!1,p.Operator)}else this.tokenText=this.processToken(this.tokenText,t)}while(this.incrementCursor()<e.length);return this.processToken(this.tokenText,t),t},e.prototype.incrementCursor=function(e){void 0===e&&(e=1);for(var t=0;t<e;t++)this._cursor=this._cursor+1,"\n"===this._script[this._cursor]?(this._currentLine++,this._currentColumn=0):this._currentColumn++;return this._cursor},e.prototype.recognizeToken=function(e,t){void 0===t&&(t=null);var n=e;return null===t&&("null"===e?(t=p.LiteralNull,n=null):"true"===e||"false"===e?(t=p.LiteralBool,n="true"===e):null!==this.parseNumberOrNull(e)?(t=p.LiteralNumber,n=this.parseNumberOrNull(e)):t=ce.indexOf(e)>=0?p.Keyword:p.Identifier),{value:n,type:t}},e.prototype.processToken=function(e,t,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=null),!e.length&&!n||"\n"===e)return"";var o=this.recognizeToken(e,r);return t.push([o.value,Uint16Array.of(o.type,this._startLine,this._startColumn,this._currentLine,this._currentColumn)]),""},e.prototype.parseNumberOrNull=function(e){if("number"==typeof e)return e;if(!e||"string"!=typeof e)return null;for(var t=(e=e.trim()).length-1;t>=0;t--){var n=e.charCodeAt(t);if((n<48||n>57)&&46!==n&&44!==n&&(45!==n||0!==t))return null}var r=parseFloat(e);return isNaN(r)?null:r},e.prototype.isPartOfNumber=function(e,t){if("-"===e&&!this.tokenText.length){var n=0!==t.length?t[t.length-1]:null;return null===n||k(n)===p.Operator&&")"!==b(n)}return"."===e&&null!==this.parseNumberOrNull(this.tokenText)},e}();var he=function(){function e(){this.initialScope=r({},oe),this._lastExecutionContext=null}return e.create=function(){return new e},Object.defineProperty(e.prototype,"initialExecutionContext",{get:function(){return this.initialScope},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastExecutionContext",{get:function(){return this._lastExecutionContext},enumerable:!1,configurable:!0}),e.prototype.cleanUp=function(){this._lastExecutionContext=null},e.prototype.jsPythonInfo=function(){return oe.jsPython()},e.prototype.tokenize=function(e){return(new ue).tokenize(e)},e.prototype.parse=function(e,t){void 0===t&&(t="main.jspy");var n=new ue;return(new se).parse(n.tokenize(e),t)},e.prototype.eval=function(e,t,n,r){void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy");var o="string"==typeof e?this.parse(e,r):e,i={moduleName:r,cancellationToken:{cancel:!1},blockScope:new te(t)};i.blockScope.set("printExecutionContext",(function(){return console.log(i.blockScope.getScope())})),i.blockScope.set("getExecutionContext",(function(){return i.blockScope.getScope()})),this._lastExecutionContext=i.blockScope.getScope();var s=(new ne).evalBlock(o,i);if(n&&n.length){var a=Array.isArray(n)?n[0]:n,l=Array.isArray(n)?n.slice(1):[],c=i.blockScope.get(a);if("function"!=typeof c)throw Error("Function ".concat(n," does not exists or not a function"));return c.apply(void 0,l)}return s},e.prototype.evalAsync=function(e,t,n,r,s){return void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy"),o(this,void 0,void 0,(function(){var a,l,c,u,h,f,p,d=this;return i(this,(function(y){switch(y.label){case 0:return a="string"==typeof e?this.parse(e,r):e,l=new re,c={moduleName:r,cancellationToken:{cancel:!1},blockScope:new te(t)},"function"==typeof s&&s(c),c.blockScope.set("printExecutionContext",(function(){return console.log(c.blockScope.getScope())})),c.blockScope.set("getExecutionContext",(function(){return c.blockScope.getScope()})),this._lastExecutionContext=c.blockScope.getScope(),[4,l.registerJsonFileLoader((function(e){return o(d,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.moduleLoader?this.moduleLoader(e):Promise.reject("ModuleLoader is not registered")];case 1:return[2,t.sent()]}}))}))})).registerModuleParser((function(e){return o(d,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.moduleParser(e)];case 1:return[2,t.sent()]}}))}))})).registerBlockContextFactory((function(e,n){var r=d.assignImportContext(n,t),o={moduleName:e,blockScope:new te(r),cancellationToken:c.cancellationToken};return o.blockScope.set("printExecutionContext",(function(){return console.log(o.blockScope.getScope())})),o.blockScope.set("getExecutionContext",(function(){return o.blockScope.getScope()})),o})).evalBlockAsync(a,c)];case 1:return u=y.sent(),n&&n.length?[3,2]:[2,u];case 2:if(h=Array.isArray(n)?n[0]:n,f=Array.isArray(n)?n.slice(1):[],"function"!=typeof(p=c.blockScope.get(h)))throw Error("Function ".concat(n," does not exists or not a function"));return[4,p.apply(void 0,f)];case 3:return[2,y.sent()]}}))}))},e.prototype.evaluate=function(e,t,n,s,a){return void 0===t&&(t={}),void 0===n&&(n=""),void 0===s&&(s="main.jspy"),o(this,void 0,void 0,(function(){var o,l;return i(this,(function(i){switch(i.label){case 0:return e&&e.length?(o=this.parse(e,s),t=t&&"object"==typeof t?t:{},t=this.assignImportContext(o,t),l=r(r({},this.initialScope),t),[4,this.evalAsync(o,l,n,s,a)]):[2,null];case 1:return[2,i.sent()]}}))}))},e.prototype.registerPackagesLoader=function(e){if("function"!=typeof e)throw Error("PackagesLoader");return this.packageLoader=e,this},e.prototype.registerModuleLoader=function(e){if("function"!=typeof e)throw Error("ModuleLoader should be a function");return this.moduleLoader=e,this},e.prototype.addFunction=function(e,t){return this.initialScope[e]=t,this},e.prototype.assignGlobalContext=function(e){return Object.assign(this.initialScope,e),this},e.prototype.hasFunction=function(e,t){return void 0===e&&(e=""),e.indexOf("def ".concat(t))>-1},e.prototype.assignImportContext=function(e,t){var n=e.body.filter((function(e){return"import"===e.type})).filter((function(e){return"jsPackage"===a(e.module.name)})).map((function(e){return function(e){var t;return{name:e.module.name,as:e.module.alias,properties:null===(t=e.parts)||void 0===t?void 0:t.map((function(e){return{name:e.name,as:e.alias}}))}}(e)}));if(n.length&&this.packageLoader){var o=this.packageResolver(n);t=r(r({},t),o)}return t},e.prototype.moduleParser=function(e){return o(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:if(!this.moduleLoader)throw new Error("Module Loader is not registered");return[4,this.moduleLoader(e)];case 1:return t=n.sent(),[2,this.parse(t,e)]}}))}))},e.prototype.packageResolver=function(e){var t=this;if(!this.packageLoader)throw Error("Package loader not provided.");var n={};return e.forEach((function(e){var r=e.name,o=e.as,i=e.properties,s=t.packageLoader&&t.packageLoader(r)||{};(null==i?void 0:i.length)?i.forEach((function(e){n[e.as||e.name]=s[e.name]})):o?n[o]=s:n[r]=s,o&&(n[o]=s)})),n},e}();e.Interpreter=he,e.jsPython=function(){return he.create()}}));