!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).ASS=e()}(this,(function(){"use strict";function t(t){var e=t.toLowerCase().trim().split(/\s*;\s*/);return"banner"===e[0]?{name:e[0],delay:1*e[1]||0,leftToRight:1*e[2]||0,fadeAwayWidth:1*e[3]||0}:/^scroll\s/.test(e[0])?{name:e[0],y1:Math.min(1*e[1],1*e[2]),y2:Math.max(1*e[1],1*e[2]),delay:1*e[3]||0,fadeAwayHeight:1*e[4]||0}:""!==t?{name:t}:null}function e(t){return t?t.toLowerCase().replace(/([+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?)/g," $1 ").replace(/([mnlbspc])/g," $1 ").trim().replace(/\s+/g," ").split(/\s(?=[mnlbspc])/).map((function(t){return t.split(" ").filter((function(t,e){return!(e&&Number.isNaN(1*t))}))})):[]}var i=["b","i","u","s","fsp","k","K","kf","ko","kt","fe","q","p","pbo","a","an","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"].map((function(t){return{name:t,regex:new RegExp("^"+t+"-?\\d")}}));function a(t){for(var n,r={},s=0;s<i.length;s++){var o=i[s],l=o.name;if(o.regex.test(t))return r[l]=1*t.slice(l.length),r}if(/^fn/.test(t))r.fn=t.slice(2);else if(/^r/.test(t))r.r=t.slice(1);else if(/^fs[\d+-]/.test(t))r.fs=t.slice(2);else if(/^\d?c&?H?[0-9a-fA-F]+|^\d?c$/.test(t)){var h=t.match(/^(\d?)c&?H?(\w*)/),c=h[1],d=h[2];r["c"+(c||1)]=d&&("000000"+d).slice(-6)}else if(/^\da&?H?[0-9a-fA-F]+/.test(t)){var f=t.match(/^(\d)a&?H?([0-9a-f]+)/i),p=f[1],u=f[2];r["a"+p]=("00"+u).slice(-2)}else if(/^alpha&?H?[0-9a-fA-F]+/.test(t))n=t.match(/^alpha&?H?([0-9a-f]+)/i),r.alpha=n[1],r.alpha=("00"+r.alpha).slice(-2);else if(/^(?:pos|org|move|fad|fade)\([^)]+/.test(t)){var g=t.match(/^(\w+)\((.*?)\)?$/),m=g[1],v=g[2];r[m]=v.trim().split(/\s*,\s*/).map(Number)}else if(/^i?clip\([^)]+/.test(t)){var y=t.match(/^i?clip\((.*?)\)?$/)[1].trim().split(/\s*,\s*/);r.clip={inverse:/iclip/.test(t),scale:1,drawing:null,dots:null},1===y.length&&(r.clip.drawing=e(y[0])),2===y.length&&(r.clip.scale=1*y[0],r.clip.drawing=e(y[1])),4===y.length&&(r.clip.dots=y.map(Number))}else if(/^t\(/.test(t)){var x=t.match(/^t\((.*?)\)?$/)[1].trim().replace(/\\.*/,(function(t){return t.replace(/,/g,"\n")})).split(/\s*,\s*/);if(!x[0])return r;r.t={t1:0,t2:0,accel:1,tags:x[x.length-1].replace(/\n/g,",").split("\\").slice(1).map(a)},2===x.length&&(r.t.accel=1*x[0]),3===x.length&&(r.t.t1=1*x[0],r.t.t2=1*x[1]),4===x.length&&(r.t.t1=1*x[0],r.t.t2=1*x[1],r.t.accel=1*x[2])}return r}function n(t){for(var e=[],i=0,n="",r=t.split("\\").slice(1).concat("").join("\\"),s=0;s<r.length;s++){var o=r[s];"("===o&&i++,")"===o&&i--,i<0&&(i=0),i||"\\"!==o?n+=o:(n&&e.push(n),n="")}return e.map(a)}function r(t){var i=t.split(/{([^{}]*?)}/),a=[];i[0].length&&a.push({tags:[],text:i[0],drawing:[]});for(var r=1;r<i.length;r+=2){var s=n(i[r]),o=s.reduce((function(t,e){return void 0===e.p?t:!!e.p}),!1);a.push({tags:s,text:o?"":i[r+1],drawing:o?e(i[r+1]):[]})}return{raw:t,combined:a.map((function(t){return t.text})).join(""),parsed:a}}function s(e,i){var a=e.split(",");if(a.length>i.length){var n=a.slice(i.length-1).join();(a=a.slice(0,i.length-1)).push(n)}for(var s,o={},l=0;l<a.length;l++){var h=i[l],c=a[l].trim();switch(h){case"Layer":case"MarginL":case"MarginR":case"MarginV":o[h]=1*c;break;case"Start":case"End":o[h]=(s=void 0,3600*(s=c.split(":"))[0]+60*s[1]+1*s[2]);break;case"Effect":o[h]=t(c);break;case"Text":o[h]=r(c);break;default:o[h]=c}}return o}var o=Object.assign||function(t){for(var e=[],i=arguments.length-1;i-- >0;)e[i]=arguments[i+1];for(var a=0;a<e.length;a++)if(e[a])for(var n=Object.keys(e[a]),r=0;r<n.length;r++)t[n[r]]=e[a][n[r]];return t},l=["Name","Fontname","Fontsize","PrimaryColour","SecondaryColour","OutlineColour","BackColour","Bold","Italic","Underline","StrikeOut","ScaleX","ScaleY","Spacing","Angle","BorderStyle","Outline","Shadow","Alignment","MarginL","MarginR","MarginV","Encoding"],h=["Layer","Start","End","Style","Name","MarginL","MarginR","MarginV","Effect","Text"];function c(t){var e=l.concat(h);return t.match(/Format\s*:\s*(.*)/i)[1].split(/\s*,\s*/).map((function(t){return e.find((function(e){return e.toLowerCase()===t.toLowerCase()}))||t}))}function d(t,e){var i=t.match(/Style\s*:\s*(.*)/i)[1].split(/\s*,\s*/);return o.apply(void 0,[{}].concat(e.map((function(t,e){var a;return(a={})[t]=i[e],a}))))}function f(t){var e={type:null,prev:null,next:null,points:[]};/[mnlbs]/.test(t[0])&&(e.type=t[0].toUpperCase().replace("N","L").replace("B","C"));for(var i=t.length-!(1&t.length),a=1;a<i;a+=2)e.points.push({x:1*t[a],y:1*t[a+1]});return e}function p(t){return!(!t.points.length||!t.type)&&!(/C|S/.test(t.type)&&t.points.length<3)}function u(t){return t.map((function(t){return t.type+t.points.map((function(t){return t.x+","+t.y})).join(",")})).join("")}function g(t){for(var e,i=[],a=0;a<t.length;){var n=t[a],r=f(n);if(p(r)){if("S"===r.type){var s=(i[a-1]||{points:[{x:0,y:0}]}).points.slice(-1)[0],l=s.x,h=s.y;r.points.unshift({x:l,y:h})}a&&(r.prev=i[a-1].type,i[a-1].next=r.type),i.push(r),a++}else{if(a&&"S"===i[a-1].type){var c={p:r.points,c:i[a-1].points.slice(0,3)};i[a-1].points=i[a-1].points.concat((c[n[0]]||[]).map((function(t){return{x:t.x,y:t.y}})))}t.splice(a,1)}}var d=(e=[]).concat.apply(e,i.map((function(t){var e=t.type,i=t.points,a=t.prev,n=t.next;return"S"===e?function(t,e,i){var a=[],n=[0,2/3,1/3,0],r=[0,1/3,2/3,0],s=[0,1/6,2/3,1/6],o=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},l=[t[t.length-1].x,t[0].x,t[1].x,t[2].x],h=[t[t.length-1].y,t[0].y,t[1].y,t[2].y];a.push({type:"M"===e?"M":"L",points:[{x:o(s,l),y:o(s,h)}]});for(var c=3;c<t.length;c++)l=[t[c-3].x,t[c-2].x,t[c-1].x,t[c].x],h=[t[c-3].y,t[c-2].y,t[c-1].y,t[c].y],a.push({type:"C",points:[{x:o(n,l),y:o(n,h)},{x:o(r,l),y:o(r,h)},{x:o(s,l),y:o(s,h)}]});if("L"===i||"C"===i){var d=t[t.length-1];a.push({type:"L",points:[{x:d.x,y:d.y}]})}return a}(i,a,n):{type:e,points:i}})));return o({instructions:d,d:u(d)},function(t){var e,i=1/0,a=1/0,n=-1/0,r=-1/0;return(e=[]).concat.apply(e,t.map((function(t){return t.points}))).forEach((function(t){var e=t.x,s=t.y;i=Math.min(i,e),a=Math.min(a,s),n=Math.max(n,e),r=Math.max(r,s)})),{minX:i,minY:a,width:n-i,height:r-a}}(i))}var m=["fs","clip","c1","c2","c3","c4","a1","a2","a3","a4","alpha","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function v(t,e,i){var a,n,r;void 0===i&&(i={});var s=t[e];if(void 0===s)return null;if("pos"===e||"org"===e)return 2===s.length?((a={})[e]={x:s[0],y:s[1]},a):null;if("move"===e){var l=s[0],h=s[1],c=s[2],d=s[3],f=s[4];void 0===f&&(f=0);var p=s[5];return void 0===p&&(p=0),4===s.length||6===s.length?{move:{x1:l,y1:h,x2:c,y2:d,t1:f,t2:p}}:null}if("fad"===e||"fade"===e)return 2===s.length?{fade:{type:"fad",t1:s[0],t2:s[1]}}:7===s.length?{fade:{type:"fade",a1:s[0],a2:s[1],a3:s[2],t1:s[3],t2:s[4],t3:s[5],t4:s[6]}}:null;if("clip"===e){var u=s.inverse,y=s.scale,x=s.drawing,b=s.dots;return x?{clip:{inverse:u,scale:y,drawing:g(x),dots:b}}:b?{clip:{inverse:u,scale:y,drawing:x,dots:{x1:b[0],y1:b[1],x2:b[2],y2:b[3]}}}:null}if(/^[xy]?(bord|shad)$/.test(e)&&(s=Math.max(s,0)),"bord"===e)return{xbord:s,ybord:s};if("shad"===e)return{xshad:s,yshad:s};if(/^c\d$/.test(e))return(n={})[e]=s||i[e],n;if("alpha"===e)return{a1:s,a2:s,a3:s,a4:s};if("fr"===e)return{frz:s};if("fs"===e)return{fs:/^\+|-/.test(s)?(1*s>-10?1+s/10:1)*i.fs:1*s};if("K"===e)return{kf:s};if("t"===e){var w=s.t1,S=s.accel,_=s.tags,C=s.t2||1e3*(i.end-i.start),$={};return _.forEach((function(t){var e=Object.keys(t)[0];~m.indexOf(e)&&("clip"!==e||t[e].dots)&&o($,v(t,e,i))})),{t:{t1:w,t2:C,accel:S,tag:$}}}return(r={})[e]=s,r}var y=[null,1,2,3,null,7,8,9,null,4,5,6],x=["r","a","an","pos","org","move","fade","fad","clip"];function b(t){for(var e,i,a,n,r,s,l,h=t.styles,c=t.style,d=t.parsed,f=t.start,p=t.end,u=[],m={style:c,fragments:[]},b={},w=0;w<d.length;w++){for(var S=d[w],_=S.tags,C=S.text,$=S.drawing,A=void 0,M=0;M<_.length;M++){var N=_[M];A=void 0===N.r?A:N.r}for(var k={tag:void 0===A?(l=b,JSON.parse(JSON.stringify(o({},l,{k:void 0,kf:void 0,ko:void 0,kt:void 0})))):{},text:C,drawing:$.length?g($):null},E=0;E<_.length;E++){var F=_[E];e=e||y[F.a||0]||F.an,i=i||v(F,"pos"),a=a||v(F,"org"),n=n||v(F,"move"),r=r||v(F,"fade")||v(F,"fad"),s=v(F,"clip")||s;var T=Object.keys(F)[0];if(T&&!~x.indexOf(T)){var j=h[c].tag,L=v(F,T,{start:f,end:p,c1:j.c1,c2:j.c2,c3:j.c3,c4:j.c4,fs:b.fs||j.fs});"t"===T?(k.tag.t=k.tag.t||[],k.tag.t.push(L.t)):o(k.tag,L)}}if(b=k.tag,void 0!==A&&(u.push(m),m={style:h[A]?A:c,fragments:[]}),k.text||k.drawing){var B=m.fragments[m.fragments.length-1]||{};B.text&&k.text&&!Object.keys(k.tag).length?B.text+=k.text:m.fragments.push(k)}}return u.push(m),o({alignment:e,slices:u},i,a,n,r,s)}function w(t){for(var e=t.styles,i=t.dialogues,a=1/0,n=[],r=0;r<i.length;r++){var s=i[r];if(!(s.Start>=s.End)){e[s.Style]||(s.Style="Default");var l=e[s.Style].style,h=b({styles:e,style:s.Style,parsed:s.Text.parsed,start:s.Start,end:s.End}),c=h.alignment||l.Alignment;a=Math.min(a,s.Layer),n.push(o({layer:s.Layer,start:s.Start,end:s.End,style:s.Style,name:s.Name,margin:{left:s.MarginL||l.MarginL,right:s.MarginR||l.MarginR,vertical:s.MarginV||l.MarginV},effect:s.Effect},h,{alignment:c}))}}for(var d=0;d<n.length;d++)n[d].layer-=a;return n.sort((function(t,e){return t.start-e.start||t.end-e.end}))}var S={Name:"Default",Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF&",SecondaryColour:"&H000000FF&",OutlineColour:"&H00000000&",BackColour:"&H00000000&",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2",Alignment:"2",MarginL:"10",MarginR:"10",MarginV:"10",Encoding:"1"};function _(t){if(/^(&|H|&H)[0-9a-f]{6,}/i.test(t)){var e=t.match(/&?H?([0-9a-f]{2})?([0-9a-f]{6})/i);return[e[1]||"00",e[2]]}var i=parseInt(t,10);if(!Number.isNaN(i)){var a=-2147483648;if(i<a)return["00","000000"];var n=a<=i&&i<=2147483647?("00000000"+(i<0?i+4294967296:i).toString(16)).slice(-8):String(i).slice(0,8);return[n.slice(0,2),n.slice(2)]}return["00","000000"]}function C(t,e){void 0===e&&(e={});var i=function(t){for(var e={info:{},styles:{format:[],style:[]},events:{format:[],comment:[],dialogue:[]}},i=t.split(/\r?\n/),a=0,n=0;n<i.length;n++){var r=i[n].trim();if(!/^;/.test(r)&&(/^\[Script Info\]/i.test(r)?a=1:/^\[V4\+? Styles\]/i.test(r)?a=2:/^\[Events\]/i.test(r)?a=3:/^\[.*\]/.test(r)&&(a=0),0!==a)){if(1===a&&/:/.test(r)){var o=r.match(/(.*?)\s*:\s*(.*)/),l=o[1],h=o[2];e.info[l]=h}if(2===a&&(/^Format\s*:/i.test(r)&&(e.styles.format=c(r)),/^Style\s*:/i.test(r)&&e.styles.style.push(d(r,e.styles.format))),3===a&&(/^Format\s*:/i.test(r)&&(e.events.format=c(r)),/^(?:Comment|Dialogue)\s*:/i.test(r))){var f=r.match(/^(\w+?)\s*:\s*(.*)/i),p=f[1],u=f[2];e.events[p.toLowerCase()].push(s(u,e.events.format))}}}return e}(t),a=function(t){for(var e=t.info,i=t.style,a=t.defaultStyle,n={},r=[o({},a,{Name:"Default"})].concat(i),s=function(t){var i=o({},S,r[t]);/^(\*+)Default$/.test(i.Name)&&(i.Name="Default"),Object.keys(i).forEach((function(t){"Name"===t||"Fontname"===t||/Colour/.test(t)||(i[t]*=1)}));var a=_(i.PrimaryColour),s=a[0],l=a[1],h=_(i.SecondaryColour),c=h[0],d=h[1],f=_(i.OutlineColour),p=f[0],u=f[1],g=_(i.BackColour),m=g[0],v=g[1],y={fn:i.Fontname,fs:i.Fontsize,c1:l,a1:s,c2:d,a2:c,c3:u,a3:p,c4:v,a4:m,b:Math.abs(i.Bold),i:Math.abs(i.Italic),u:Math.abs(i.Underline),s:Math.abs(i.StrikeOut),fscx:i.ScaleX,fscy:i.ScaleY,fsp:i.Spacing,frz:i.Angle,xbord:i.Outline,ybord:i.Outline,xshad:i.Shadow,yshad:i.Shadow,fe:i.Encoding,q:/^[0-3]$/.test(e.WrapStyle)?1*e.WrapStyle:2};n[i.Name]={style:i,tag:y}},l=0;l<r.length;l++)s(l);return n}({info:i.info,style:i.styles.style,defaultStyle:e.defaultStyle||{}});return{info:i.info,width:1*i.info.PlayResX||null,height:1*i.info.PlayResY||null,collisions:i.info.Collisions||"Normal",styles:a,dialogues:w({styles:a,dialogues:i.events.dialogue})}}var $=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)},A=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function M(t){var e=t.match(/(\w\w)(\w\w)(\w\w)(\w\w)/),i=1-("0x"+e[1])/255,a=+("0x"+e[2]),n=+("0x"+e[3]);return"rgba("+ +("0x"+e[4])+","+n+","+a+","+i+")"}function N(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}function k(t,e){void 0===e&&(e=[]);for(var i=document.createElementNS("http://www.w3.org/2000/svg",t),a=0;a<e.length;a++){var n=e[a];i.setAttributeNS("xlink:href"===n[0]?"http://www.w3.org/1999/xlink":null,n[0],n[1])}return i}function E(t){var e=document.body.style,i=t.replace(/^\w/,(function(t){return t.toUpperCase()}));return t in e?"":"webkit"+i in e?"-webkit-":"moz"+i in e?"-moz-":""}var F={transform:E("transform"),animation:E("animation"),clipPath:E("clipPath")};function T(t){var e=t.getRootNode?t.getRootNode():document;return e===document?e.head:e}var j=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur","be"],L=["fscx","fscy","frx","fry","frz","fax","fay"];function B(t){var e=this._.scriptRes.width,i=this._.scriptRes.height,a="";if(null!==t.dots){var n=t.dots,r=n.x1,s=n.y1,o=n.x2,l=n.y2;a="M"+(r/=e)+","+(s/=i)+"L"+r+","+(l/=i)+","+(o/=e)+","+l+","+o+","+s+"Z"}null!==t.drawing&&(a=t.drawing.instructions.map((function(t){return t.type+t.points.map((function(t){var a=t.x,n=t.y;return a/e+","+n/i})).join(",")})).join(""));var h=1/(1<<t.scale-1);t.inverse&&(a+="M0,0L0,"+h+","+h+","+h+","+h+",0,0,0Z");var c="ASS-"+N(),d=k("clipPath",[["id",c],["clipPathUnits","objectBoundingBox"]]);return d.appendChild(k("path",[["d",a],["transform","scale("+h+")"],["clip-rule","evenodd"]])),this._.$defs.appendChild(d),{$clipPath:d,cssText:F.clipPath+"clip-path:url(#"+c+");"}}function O(t){if(t.clip){var e=document.createElement("div");this._.$stage.insertBefore(e,t.$div),e.appendChild(t.$div),e.className="ASS-fix-objectBoundingBox";var i=B.call(this,t.clip),a=i.cssText,n=i.$clipPath;this._.$defs.appendChild(n),e.style.cssText=a,o(t,{$div:e,$clipPath:n})}}var R=document.createElement("div");R.className="ASS-fix-font-size",R.textContent="M";var z=Object.create(null);function H(t,e){var i=t+"-"+e;return z[i]||(R.style.cssText="line-height:normal;font-size:"+e+'px;font-family:"'+t+'",Arial;',z[i]=e*e/R.clientHeight),z[i]}function P(t,e){var i=[],a=M(t.a3+t.c3),n=t.xbord*e,r=t.ybord*e,s=M(t.a4+t.c4),o=t.xshad*e,l=t.yshad*e,h=t.blur||t.be||0;if(!(n+r+o+l))return"none";if(n||r)for(var c=-1;c<=1;c++)for(var d=-1;d<=1;d++){for(var f=1;f<n;f++)for(var p=1;p<r;p++)(c||d)&&i.push(a+" "+c*f+"px "+d*p+"px "+h+"px");i.push(a+" "+c*n+"px "+d*r+"px "+h+"px")}if(o||l){var u=o>0?1:-1,g=l>0?1:-1;o=Math.abs(o),l=Math.abs(l);for(var m=Math.max(n,o-n);m<o+n;m++)for(var v=Math.max(r,l-r);v<l+r;v++)i.push(s+" "+m*u+"px "+v*g+"px "+h+"px");i.push(s+" "+(o+n)*u+"px "+(l+r)*g+"px "+h+"px")}return i.join()}function q(t){return["perspective(314px)","rotateY("+(t.fry||0)+"deg)","rotateX("+(t.frx||0)+"deg)","rotateZ("+(-t.frz||0)+"deg)","scale("+(t.p?1:(t.fscx||100)/100)+","+(t.p?1:(t.fscy||100)/100)+")","skew("+(t.fax||0)+"rad,"+(t.fay||0)+"rad)"].join(" ")}function I(t,e){return"@"+F.animation+"keyframes "+t+" {"+e+"}\n"}var U=function(){this.obj={}};function Y(){var t=this,e="";return this.dialogues.forEach((function(i){var a=i.start,n=i.end,r=i.effect,s=i.move,l=i.fade,h=i.slices,c=1e3*(n-a),d=new U;if(r&&!s){var f=r.name,p=r.delay,u=r.lefttoright,g=r.y1,m=r.y2||t._.resampledRes.height;if("banner"===f){var v=t.scale*(c/p)*(u?1:-1);d.set("0.000%","transform","translateX(0)"),d.set("100.000%","transform","translateX("+v+"px)")}if(/^scroll/.test(f)){var y=/up/.test(f)?-1:1,x="translateY("+t.scale*g*y+"px)",b="translateY("+t.scale*m*y+"px)",w=(m-g)/(c/p)*100;d.set("0.000%","transform",x),w<100&&d.set(w.toFixed(3)+"%","transform",b),d.set("100.000%","transform",b)}}if(s){var S=s.x1,_=s.y1,C=s.x2,$=s.y2,A=s.t1,k=s.t2||c,E=i.pos||{x:0,y:0},F=[{x:S,y:_},{x:C,y:$}].map((function(e){var i=e.x,a=e.y;return"translate("+t.scale*(i-E.x)+"px, "+t.scale*(a-E.y)+"px)"}));d.setT({t1:A,t2:k,duration:c,prop:"transform",from:F[0],to:F[1]})}if(l)if("fad"===l.type){var T=l.t1,B=l.t2;d.set("0.000%","opacity",0),T<c?(d.set((T/c*100).toFixed(3)+"%","opacity",1),T+B<c&&d.set(((c-B)/c*100).toFixed(3)+"%","opacity",1),d.set("100.000%","opacity",0)):d.set("100.000%","opacity",c/T)}else{var O=l.a1,R=l.a2,z=l.a3,Y=l.t1,D=l.t2,X=l.t3,G=l.t4,V=[Y,D,X,G].map((function(t){return(t/c*100).toFixed(3)+"%"})),W=[O,R,z].map((function(t){return 1-t/255}));d.set("0.000%","opacity",W[0]),Y<c&&d.set(V[0],"opacity",W[0]),D<c&&d.set(V[1],"opacity",W[1]),X<c&&d.set(V[2],"opacity",W[1]),G<c&&d.set(V[3],"opacity",W[2]),d.set("100.000%","opacity",W[2])}var J=d.toString();J&&(o(i,{animationName:"ASS-"+N()}),e+=I(i.animationName,J)),h.forEach((function(i){var a=t.styles[i.style].tag;i.fragments.forEach((function(i){if(i.tag.t&&i.tag.t.length){var n,r=new U,s=o({},a,i.tag);(n=i.tag.t,n.reduceRight((function(t,e){var i=!1;return t.map((function(t){return i=e.t1===t.t1&&e.t2===t.t2&&e.accel===t.accel,o({},t,i?{tag:o({},t.tag,e.tag)}:{})})).concat(i?[]:e)}),[])).forEach((function(e){var n=e.t1,l=e.t2,h=e.tag;if(h.fs){var d=t.scale*H(s.fn,s.fs)+"px",f=t.scale*H(h.fn,s.fs)+"px";r.setT({t1:n,t2:l,duration:c,prop:"font-size",from:d,to:f})}if(h.fsp){var p=t.scale*s.fsp+"px",u=t.scale*h.fsp+"px";r.setT({t1:n,t2:l,duration:c,prop:"letter-spacing",from:p,to:u})}var g=void 0!==h.a1&&h.a1===h.a2&&h.a2===h.a3&&h.a3===h.a4;if(h.c1||h.a1&&!g){var m=M(s.a1+s.c1),v=M((h.a1||s.a1)+(h.c1||s.c1));r.setT({t1:n,t2:l,duration:c,prop:"color",from:m,to:v})}if(g){var y=1-parseInt(s.a1,16)/255,x=1-parseInt(h.a1,16)/255;r.setT({t1:n,t2:l,duration:c,prop:"opacity",from:y,to:x})}if(j.some((function(t){return void 0!==h[t]&&h[t]!==(i.tag[t]||a[t])}))){var b=/Yes/i.test(t.info.ScaledBorderAndShadow)?t.scale:1,w=P(s,b),S=P(o({},s,h),b);r.setT({t1:n,t2:l,duration:c,prop:"text-shadow",from:w,to:S})}if(L.some((function(t){return void 0!==h[t]&&h[t]!==(i.tag[t]||a[t])}))){var _=o({},s,h);i.drawing&&(o(_,{p:0,fscx:(h.fscx||s.fscx)/s.fscx*100,fscy:(h.fscy||s.fscy)/s.fscy*100}),o(s,{fscx:100,fscy:100}));var C=q(s),$=q(_);r.setT({t1:n,t2:l,duration:c,prop:"transform",from:C,to:$})}}));var l=r.toString();o(i,{animationName:"ASS-"+N()}),e+=I(i.animationName,l)}}))}))})),e}function D(t,e,i){var a=F.animation;return a+"animation-name:"+t+";"+a+"animation-duration:"+e+"s;"+a+"animation-delay:"+i+"s;"+a+"animation-timing-function:linear;"+a+"animation-iteration-count:1;"+a+"animation-fill-mode:forwards;"}function X(t,e){var i=o({},e,t.tag),a=t.drawing,n=a.minX,r=a.minY,s=a.width,l=a.height,h=this.scale/(1<<i.p-1),c=(i.fscx?i.fscx/100:1)*h,d=(i.fscy?i.fscy/100:1)*h,f=i.blur||i.be||0,p=i.xbord+(i.xshad<0?-i.xshad:0)+f,u=i.ybord+(i.yshad<0?-i.yshad:0)+f,g=s*c+2*i.xbord+Math.abs(i.xshad)+2*f,m=l*d+2*i.ybord+Math.abs(i.yshad)+2*f,v=k("svg",[["width",g],["height",m],["viewBox",-p+" "+-u+" "+g+" "+m]]),y=/Yes/i.test(this.info.ScaledBorderAndShadow)?this.scale:1,x="ASS-"+N(),b=k("defs");b.appendChild(function(t,e,i){var a=t.xbord||t.ybord,n=t.xshad||t.yshad,r="FF"!==t.a1,s=t.blur||t.be||0,o=k("filter",[["id",e]]);o.appendChild(k("feGaussianBlur",[["stdDeviation",a?0:s],["in","SourceGraphic"],["result","sg_b"]])),o.appendChild(k("feFlood",[["flood-color",M(t.a1+t.c1)],["result","c1"]])),o.appendChild(k("feComposite",[["operator","in"],["in","c1"],["in2","sg_b"],["result","main"]])),a&&(o.appendChild(k("feMorphology",[["radius",t.xbord*i+" "+t.ybord*i],["operator","dilate"],["in","SourceGraphic"],["result","dil"]])),o.appendChild(k("feGaussianBlur",[["stdDeviation",s],["in","dil"],["result","dil_b"]])),o.appendChild(k("feComposite",[["operator","out"],["in","dil_b"],["in2","SourceGraphic"],["result","dil_b_o"]])),o.appendChild(k("feFlood",[["flood-color",M(t.a3+t.c3)],["result","c3"]])),o.appendChild(k("feComposite",[["operator","in"],["in","c3"],["in2","dil_b_o"],["result","border"]]))),n&&(a||r)&&(o.appendChild(k("feOffset",[["dx",t.xshad*i],["dy",t.yshad*i],["in",a?"dil":"SourceGraphic"],["result","off"]])),o.appendChild(k("feGaussianBlur",[["stdDeviation",s],["in","off"],["result","off_b"]])),r||(o.appendChild(k("feOffset",[["dx",t.xshad*i],["dy",t.yshad*i],["in","SourceGraphic"],["result","sg_off"]])),o.appendChild(k("feComposite",[["operator","out"],["in","off_b"],["in2","sg_off"],["result","off_b_o"]]))),o.appendChild(k("feFlood",[["flood-color",M(t.a4+t.c4)],["result","c4"]])),o.appendChild(k("feComposite",[["operator","in"],["in","c4"],["in2",r?"off_b":"off_b_o"],["result","shadow"]])));var l=k("feMerge",[]);return n&&(a||r)&&l.appendChild(k("feMergeNode",[["in","shadow"]])),a&&l.appendChild(k("feMergeNode",[["in","border"]])),l.appendChild(k("feMergeNode",[["in","main"]])),o.appendChild(l),o}(i,x,y)),v.appendChild(b);var w="ASS-"+N(),S=k("symbol",[["id",w],["viewBox",n+" "+r+" "+s+" "+l]]);return S.appendChild(k("path",[["d",t.drawing.d]])),v.appendChild(S),v.appendChild(k("use",[["width",s*c],["height",l*d],["xlink:href","#"+w],["filter","url(#"+x+")"]])),v.style.cssText="position:absolute;left:"+(n*c-p)+"px;top:"+(r*d-u)+"px;",{$svg:v,cssText:"position:relative;width:"+s*c+"px;height:"+l*d+"px;"}}function G(t){var e=this,i=document.createElement("div");i.className="ASS-dialogue";var a=document.createDocumentFragment(),n=t.slices,r=t.start,s=t.end;return n.forEach((function(t){var i=e.styles[t.style].tag,n=e.styles[t.style].style.BorderStyle;t.fragments.forEach((function(t){var l=t.text,h=t.drawing,c=t.animationName,d=o({},i,t.tag),f="display:inline-block;",p=e.video.currentTime;if(!h){f+='line-height:normal;font-family:"'+d.fn+'",Arial;',f+="font-size:"+e.scale*H(d.fn,d.fs)+"px;",f+="color:"+M(d.a1+d.c1)+";";var u=/Yes/i.test(e.info.ScaledBorderAndShadow)?e.scale:1;1===n&&(f+="text-shadow:"+P(d,u)+";"),3===n&&(f+="background-color:"+M(d.a3+d.c3)+";box-shadow:"+P(d,u)+";"),f+=d.b?"font-weight:"+(1===d.b?"bold":d.b)+";":"",f+=d.i?"font-style:italic;":"",f+=d.u||d.s?"text-decoration:"+(d.u?"underline":"")+" "+(d.s?"line-through":"")+";":"",f+=d.fsp?"letter-spacing:"+d.fsp+"px;":"",1!==d.q&&0!==d.q&&3!==d.q||(f+="word-break:break-all;white-space:normal;"),2===d.q&&(f+="word-break:normal;white-space:nowrap;")}if(L.some((function(t){return/^fsc[xy]$/.test(t)?100!==d[t]:!!d[t]}))&&(f+=F.transform+"transform:"+q(d)+";",h||(f+="transform-style:preserve-3d;word-break:normal;white-space:nowrap;")),c&&(f+=D(c,s-r,Math.min(0,r-p))),h&&d.pbo){var g=e.scale*-d.pbo*(d.fscy||100)/100;f+="vertical-align:"+g+"px;"}var m=/"fr[xyz]":[^0]/.test(JSON.stringify(d));(function(t,e){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\s/g,"&nbsp;").replace(/\\h/g,"&nbsp;").replace(/\\N/g,"<br>").replace(/\\n/g,2===e?"<br>":"&nbsp;")})(l,d.q).split("<br>").forEach((function(n,r){var s=document.createElement("span");if(s.dataset.hasRotate=m,h){var o=X.call(e,t,i);s.style.cssText=o.cssText,s.appendChild(o.$svg)}else{if(r&&a.appendChild(document.createElement("br")),!n)return;s.innerHTML=n}s.style.cssText+=f,a.appendChild(s)}))}))})),i.appendChild(a),i}function V(t){var e=t.layer,i=t.margin,a=t.width,n=t.height,r=t.alignment,s=t.end,o=this.width-(this.scale*(i.left+i.right)|0),l=this.height,h=this.scale*i.vertical|0,c=100*this.video.currentTime;this._.space[e]=this._.space[e]||{left:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)},center:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)},right:{width:new Uint16Array(l+1),end:new Uint16Array(l+1)}};var d=this._.space[e],f=["right","left","center"][r%3],p=0,u=0,g=function(t){return p=function(t){var e=d.left.width[t],i=d.center.width[t],n=d.right.width[t],r=d.left.end[t],s=d.center.end[t],l=d.right.end[t];return"left"===f&&(r>c&&e||s>c&&i&&2*a+i>o||l>c&&n&&a+n>o)||"center"===f&&(r>c&&e&&2*e+a>o||s>c&&i||l>c&&n&&2*n+a>o)||"right"===f&&(r>c&&e&&e+a>o||s>c&&i&&2*a+i>o||l>c&&n)}(t)?0:p+1,p>=n&&(u=t,!0)};if(r<=3)for(var m=l-h-1;m>h&&!g(m);m--);else if(r>=7)for(var v=h+1;v<l-h&&!g(v);v++);else for(var y=l-n>>1;y<l-h&&!g(y);y++);r>3&&(u-=n-1);for(var x=u;x<u+n;x++)d[f].width[x]=a,d[f].end[x]=100*s;return u}function W(t){var e=t.effect,i=t.move,a=t.alignment,n=t.width,r=t.height,s=t.margin,o=t.slices,l=0,h=0;if(e)"banner"===e.name&&(a<=3&&(h=this.height-r-s.vertical),a>=4&&a<=6&&(h=(this.height-r)/2),a>=7&&(h=s.vertical),l=e.lefttoright?-n:this.width);else if(t.pos||i){var c=t.pos||{x:0,y:0};a%3==1&&(l=this.scale*c.x),a%3==2&&(l=this.scale*c.x-n/2),a%3==0&&(l=this.scale*c.x-n),a<=3&&(h=this.scale*c.y-r),a>=4&&a<=6&&(h=this.scale*c.y-r/2),a>=7&&(h=this.scale*c.y)}else{a%3==1&&(l=0),a%3==2&&(l=(this.width-n)/2),a%3==0&&(l=this.width-n-this.scale*s.right),o.some((function(t){return t.fragments.some((function(t){return t.animationName}))}))?(a<=3&&(h=this.height-r-s.vertical),a>=4&&a<=6&&(h=(this.height-r)/2),a>=7&&(h=s.vertical)):h=V.call(this,t)}return{x:l,y:h}}function J(t){var e=t.layer,i=t.start,a=t.end,n=t.alignment,r=t.effect,s=t.pos,o=t.margin,l=t.animationName,h=t.width,c=t.height,d=t.x,f=t.y,p=this.video.currentTime,u="";(e&&(u+="z-index:"+e+";"),l&&(u+=D(l,a-i,Math.min(0,i-p))),u+="text-align:"+["right","left","center"][n%3]+";",r)||(u+="max-width:"+(this.width-this.scale*(o.left+o.right))+"px;",s||(n%3==1&&(u+="margin-left:"+this.scale*o.left+"px;"),n%3==0&&(u+="margin-right:"+this.scale*o.right+"px;"),h>this.width-this.scale*(o.left+o.right)&&(u+="margin-left:"+this.scale*o.left+"px;",u+="margin-right:"+this.scale*o.right+"px;")));return u+="width:"+h+"px;height:"+c+"px;left:"+d+"px;top:"+f+"px;"}function Z(t){var e=G.call(this,t);o(t,{$div:e}),this._.$stage.appendChild(e);var i=e.getBoundingClientRect(),a=i.width,n=i.height;return o(t,{width:a,height:n}),o(t,W.call(this,t)),e.style.cssText=J.call(this,t),function(t){var e=t.alignment,i=t.width,a=t.height,n=t.x,r=t.y,s=t.$div,o=t.org;o||(o={x:0,y:0},e%3==1&&(o.x=n),e%3==2&&(o.x=n+i/2),e%3==0&&(o.x=n+i),e<=3&&(o.y=r+a),e>=4&&e<=6&&(o.y=r+a/2),e>=7&&(o.y=r));for(var l=s.childNodes.length-1;l>=0;l--){var h=s.childNodes[l];if("true"===h.dataset.hasRotate){var c=o.x-n-h.offsetLeft,d=o.y-r-h.offsetTop;h.style.cssText+=F.transform+"transform-origin:"+c+"px "+d+"px;"}}}(t),O.call(this,t),t}function K(){for(var t=this.video.currentTime,e=this._.stagings.length-1;e>=0;e--){var i=this._.stagings[e],a=i.end;if(i.effect&&/scroll/.test(i.effect.name)){var n=i.effect,r=n.y1,s=n.y2,o=n.delay,l=((s||this._.resampledRes.height)-r)/(1e3/o);a=Math.min(a,i.start+l)}a<t&&(this._.$stage.removeChild(i.$div),i.$clipPath&&this._.$defs.removeChild(i.$clipPath),this._.stagings.splice(e,1))}for(var h=this.dialogues;this._.index<h.length&&t>=h[this._.index].start;){if(t<h[this._.index].end){var c=Z.call(this,h[this._.index]);this._.stagings.push(c)}++this._.index}}function Q(){var t=this,e=function(){K.call(t),t._.requestId=$(e)};return A(this._.requestId),this._.requestId=$(e),this._.$stage.classList.remove("ASS-animation-paused"),this}function tt(){return A(this._.requestId),this._.requestId=0,this._.$stage.classList.add("ASS-animation-paused"),this}function et(){for(;this._.$stage.lastChild;)this._.$stage.removeChild(this._.$stage.lastChild);for(;this._.$defs.lastChild;)this._.$defs.removeChild(this._.$defs.lastChild);this._.stagings=[],this._.space=[]}function it(){var t=this.video.currentTime,e=this.dialogues;et.call(this),this._.index=function(){for(var i=0,a=e.length-1;i+1<a&&t>e[a+i>>1].end;)i=a+i>>1;if(!i)return 0;for(var n=i;n<a;n++)if(e[n].end>t&&t>=e[n].start||n&&e[n-1].end<t&&t<e[n].start)return n;return a}(),K.call(this)}function at(){var t=this._.listener;t.play=Q.bind(this),t.pause=tt.bind(this),t.seeking=it.bind(this),this.video.addEventListener("play",t.play),this.video.addEventListener("pause",t.pause),this.video.addEventListener("seeking",t.seeking)}function nt(){var t=this._.listener;this.video.removeEventListener("play",t.play),this.video.removeEventListener("pause",t.pause),this.video.removeEventListener("seeking",t.seeking),t.play=null,t.pause=null,t.seeking=null}function rt(){var t=this.video.clientWidth,e=this.video.clientHeight,i=this.video.videoWidth||t,a=this.video.videoHeight||e,n=this._.scriptRes.width,r=this._.scriptRes.height,s=n,o=r,l=Math.min(t/i,e/a);"video_width"===this.resampling&&(o=n/i*a),"video_height"===this.resampling&&(s=r/a*i),this.scale=Math.min(t/s,e/o),"script_width"===this.resampling&&(this.scale=l*(i/s)),"script_height"===this.resampling&&(this.scale=l*(a/o)),this.width=this.scale*s,this.height=this.scale*o,this._.resampledRes={width:s,height:o},this.container.style.cssText="width:"+t+"px;height:"+e+"px;";var h="width:"+this.width+"px;height:"+this.height+"px;top:"+(e-this.height)/2+"px;left:"+(t-this.width)/2+"px;";return this._.$stage.style.cssText=h,this._.$svg.style.cssText=h,this._.$svg.setAttributeNS(null,"viewBox","0 0 "+n+" "+r),this._.$animation.innerHTML=Y.call(this),it.call(this),this}U.prototype.set=function(t,e,i){this.obj[t]||(this.obj[t]={}),this.obj[t][e]=i},U.prototype.setT=function(t){var e=t.t1,i=t.t2,a=t.duration,n=t.prop,r=t.from,s=t.to;this.set("0.000%",n,r),e<a&&this.set((e/a*100).toFixed(3)+"%",n,r),i<a&&this.set((i/a*100).toFixed(3)+"%",n,s),this.set("100.000%",n,s)},U.prototype.toString=function(){var t=this;return Object.keys(this.obj).map((function(e){return e+"{"+Object.keys(t.obj[e]).map((function(i){return""+(F[i]||"")+i+":"+t.obj[e][i]+";"})).join("")+"}"})).join("")};function st(t,e,i){if(void 0===i&&(i={}),this.scale=1,this._={index:0,stagings:[],space:[],listener:{},$svg:k("svg"),$defs:k("defs"),$stage:document.createElement("div"),$animation:document.createElement("style")},this._.$svg.appendChild(this._.$defs),this._.$stage.className="ASS-stage ASS-animation-paused",this._.resampling=i.resampling||"video_height",this.container=i.container||document.createElement("div"),this.container.classList.add("ASS-container"),this.container.appendChild(R),this.container.appendChild(this._.$svg),this._.hasInitContainer=!!i.container,this.video=e,at.call(this),!this._.hasInitContainer){var a=!e.paused;e.parentNode.insertBefore(this.container,e),this.container.appendChild(e),a&&e.paused&&e.play()}this.container.appendChild(this._.$stage);var n=C(t),r=n.info,s=n.width,o=n.height,l=n.styles,h=n.dialogues;this.info=r,this._.scriptRes={width:s||e.videoWidth,height:o||e.videoHeight},this.styles=l,this.dialogues=h;var c=T(this.container),d=c.querySelector("#ASS-global-style");return d||((d=document.createElement("style")).type="text/css",d.id="ASS-global-style",d.appendChild(document.createTextNode(".ASS-container,.ASS-stage{position:relative;overflow:hidden}.ASS-container video{position:absolute;top:0;left:0}.ASS-stage{pointer-events:none;position:absolute}.ASS-dialogue{font-size:0;position:absolute}.ASS-fix-font-size{position:absolute;visibility:hidden}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}")),c.appendChild(d)),this._.$animation.type="text/css",this._.$animation.className="ASS-animation",c.appendChild(this._.$animation),rt.call(this),this.video.paused||(it.call(this),Q.call(this)),this}function ot(){return this._.$stage.style.visibility="visible",this}function lt(){return this._.$stage.style.visibility="hidden",this}function ht(){tt.call(this),et.call(this),nt.call(this,this._.listener);var t=T(this.container);if(!this._.hasInitContainer){var e=!this.video.paused;this.container.parentNode.insertBefore(this.video,this.container),this.container.parentNode.removeChild(this.container),e&&this.video.paused&&this.video.play()}for(var i in t.removeChild(this._.$animation),this)Object.prototype.hasOwnProperty.call(this,i)&&(this[i]=null);return this}var ct=/^(video|script)_(width|height)$/;function dt(){return ct.test(this._.resampling)?this._.resampling:"video_height"}function ft(t){return t===this._.resampling?t:(ct.test(t)&&(this._.resampling=t,this.resize()),this._.resampling)}var pt=function(t,e,i){return"string"!=typeof t?this:st.call(this,t,e,i)},ut={resampling:{configurable:!0}};return pt.prototype.resize=function(){return rt.call(this)},pt.prototype.show=function(){return ot.call(this)},pt.prototype.hide=function(){return lt.call(this)},pt.prototype.destroy=function(){return ht.call(this)},ut.resampling.get=function(){return dt.call(this)},ut.resampling.set=function(t){return ft.call(this,t)},Object.defineProperties(pt.prototype,ut),pt}));
